{% extends 'base.html' %}
{% block title %}Tabelas{% endblock %}
{% block content %}
<div class="page-header d-flex align-items-center justify-content-between">
  <h4 class="mb-0">Gerenciamento de Tabelas</h4>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary" href="#imp-bras">Importar Brasíndice</a>
    <a class="btn btn-outline-primary" href="#imp-simpro">Importar SIMPRO</a>
    <a class="btn btn-outline-primary" href="#imp-diarias">Importar DTP</a>
    <a class="btn btn-outline-primary" href="#imp-cbhpm">Importar CBHPM</a>
    <a class="btn btn-outline-primary" href="#imp-porte">Importar Porte</a>
    <a class="btn btn-outline-primary" href="#imp-porte-an">Importar Porte AN</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-12">
    <div class="card p-3" id="import-jobs-panel">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Importações em andamento</h6>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshJobsBtn">
          <i class="bi bi-arrow-clockwise"></i> Atualizar
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-clean align-middle mb-0" id="jobsTable">
          <thead>
            <tr>
              <th style="width:120px;">Protocolo</th>
              <th style="width:90px;">Origem</th>
              <th style="width:120px;">Versão</th>
              <th style="width:180px;">UFs</th>
              <th style="width:110px;">Status</th>
              <th style="width:130px;">Duração</th>
              <th>Mensagem</th>
              <th style="width:180px;">Atualizado em</th>
            </tr>
          </thead>
          <tbody id="jobsTableBody">
            <tr><td colspan="8" class="text-center text-muted py-3">Nenhuma importação agendada.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="small text-muted mt-2" id="jobsSummary">—</div>
    </div>
  </div>

  <div class="col-12">
    <div class="card p-3" id="imp-bras">
      <h6 class="mb-3">Importar: Brasíndice</h6>
      <form method="post" action="{{ url_for('insumos_import') }}" enctype="multipart/form-data" class="row g-3" data-fill-label data-import-form>
        <input type="hidden" name="origem" value="BRAS">
        <input type="hidden" name="return_to" value="gerenciar_tabelas">
        <div class="col-md-4">
          <label class="form-label">Arquivo (.txt/.csv)</label>
          <input class="form-control" type="file" name="arquivo" accept=".txt,.csv" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Versão</label>
          <input class="form-control" name="versao" placeholder="ex.: 2025-09" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Identificador (opcional)</label>
          <input class="form-control" name="arquivo_label" placeholder="ex.: tabela_pf">
          <div class="form-text">Use para diferenciar arquivos da mesma versão/alíquota.</div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Data ref.</label>
          <input class="form-control" type="date" name="data_atualizacao">
        </div>
        <div class="col-md-3">
          <label class="form-label">UFs (opcional)</label>
          <select class="form-select" name="ufs" multiple size="6">
            {% for uf in UFS %}<option value="{{ uf }}">{{ uf }}</option>{% endfor %}
          </select>
          <div class="form-text">Selecione uma ou mais UFs atendidas por este arquivo (sem duplicar a importação).</div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Alíquota (%)</label>
          <input class="form-control" name="aliquota" placeholder="ex.: 18,5">
        </div>
        <div class="col-md-2">
          <label class="form-label">Sequência</label>
          <input class="form-control" name="sequencia" type="number" min="1" max="9" value="1">
        </div>
        <div class="col-md-3">
          <label class="form-label">Formato</label>
          <select class="form-select" name="format">
            <option value="delimited">Delimitado</option>
            <option value="fixed">Largura fixa</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Delimitador</label>
          <input class="form-control" name="delimiter" value=";">
        </div>
        <div class="col-md-2">
          <label class="form-label">Quote</label>
          <input class="form-control" name="quotechar" value="&quot;">
        </div>
        <div class="col-md-2">
          <label class="form-label">Codificação</label>
          <select class="form-select" name="encoding">
            <option value="">Auto (UTF-8/Latin-1)</option>
            <option value="utf-8">UTF-8</option>
            <option value="latin-1">Latin-1</option>
            <option value="cp1252">Windows-1252</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Mapa JSON (opcional)</label>
          <input class="form-control" type="file" name="map_config" accept=".json">
        </div>
        <div class="col-md-4 d-flex align-items-center">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="no_header" id="brasNoHeader">
            <label class="form-check-label" for="brasNoHeader">Arquivo sem cabeçalho</label>
          </div>
        </div>
        <div class="col-md-4 d-flex align-items-center">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="truncate" id="brasTruncate">
            <label class="form-check-label" for="brasTruncate">Limpar tabela antes de importar</label>
          </div>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Importar Brasíndice</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('insumos_dashboard') }}" target="_blank">Abrir consulta</a>
        </div>
        <div class="col-12">
          <div class="progress d-none" style="height:6px;" data-progress>
            <div class="progress-bar" role="progressbar" style="width:0%;"></div>
          </div>
          <div class="small mt-2 import-message text-muted"></div>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12">
    <div class="card p-3" id="imp-simpro">
      <h6 class="mb-3">Importar: SIMPRO</h6>
      <form method="post" action="{{ url_for('insumos_import') }}" enctype="multipart/form-data" class="row g-3" data-fill-label data-import-form>
        <input type="hidden" name="origem" value="SIMPRO">
        <input type="hidden" name="return_to" value="gerenciar_tabelas">
        <div class="col-md-4">
          <label class="form-label">Arquivo (.txt/.csv)</label>
          <input class="form-control" type="file" name="arquivo" accept=".txt,.csv" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Versão</label>
          <input class="form-control" name="versao" placeholder="ex.: 2025-09" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Identificador (opcional)</label>
          <input class="form-control" name="arquivo_label" placeholder="ex.: tabela_pf">
          <div class="form-text">Use para diferenciar arquivos da mesma versão/alíquota.</div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Data ref.</label>
          <input class="form-control" type="date" name="data_atualizacao">
        </div>
        <div class="col-md-3">
          <label class="form-label">UFs (opcional)</label>
          <select class="form-select" name="ufs" multiple size="6">
            {% for uf in UFS %}<option value="{{ uf }}">{{ uf }}</option>{% endfor %}
          </select>
          <div class="form-text">Selecione uma ou mais UFs atendidas por este arquivo (sem duplicar a importação).</div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Alíquota (%)</label>
          <input class="form-control" name="aliquota" placeholder="ex.: 18,5">
        </div>
        <div class="col-md-2">
          <label class="form-label">Sequência</label>
          <input class="form-control" name="sequencia" type="number" min="1" max="9" value="1">
        </div>
        <div class="col-md-3">
          <label class="form-label">Formato</label>
          <select class="form-select" name="format">
            <option value="delimited">Delimitado</option>
            <option value="fixed">Largura fixa</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Delimitador</label>
          <input class="form-control" name="delimiter" value=";">
        </div>
        <div class="col-md-2">
          <label class="form-label">Quote</label>
          <input class="form-control" name="quotechar" value="&quot;">
        </div>
        <div class="col-md-2">
          <label class="form-label">Codificação</label>
          <select class="form-select" name="encoding">
            <option value="">Auto (UTF-8/Latin-1)</option>
            <option value="utf-8">UTF-8</option>
            <option value="latin-1">Latin-1</option>
            <option value="cp1252">Windows-1252</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Mapa JSON (opcional)</label>
          <input class="form-control" type="file" name="map_config" accept=".json">
        </div>
        <div class="col-md-4 d-flex align-items-center">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="no_header" id="simproNoHeader">
            <label class="form-check-label" for="simproNoHeader">Arquivo sem cabeçalho</label>
          </div>
        </div>
        <div class="col-md-4 d-flex align-items-center">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="truncate" id="simproTruncate">
            <label class="form-check-label" for="simproTruncate">Limpar tabela antes de importar</label>
          </div>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-success" type="submit">Importar SIMPRO</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('insumos_dashboard') }}" target="_blank">Abrir consulta</a>
        </div>
        <div class="col-12">
          <div class="progress d-none" style="height:6px;" data-progress>
            <div class="progress-bar" role="progressbar" style="width:0%;"></div>
          </div>
          <div class="small mt-2 import-message text-muted"></div>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12">
    <div class="card p-3" id="imp-diarias">
      <h6 class="mb-3">Importar: Diárias, Taxas e Pacotes</h6>
      <!-- formulário igual ao seu, apenas estilizado -->
      <form method="post" action="{{ url_for('importar_diarias_taxas_pacotes') }}" enctype="multipart/form-data" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Operadora</label>
          <select class="form-select" name="operadora_id" required>
            <option value="" disabled selected>Selecione…</option>
            {% for op in operadoras %}<option value="{{ op.id }}">{{ op.nome }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Nome da Tabela</label>
          <input class="form-control" name="nome_tabela" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Prestador (opcional)</label>
          <input class="form-control" name="prestador">
        </div>
        <div class="col-md-2">
          <label class="form-label">UF</label>
          <select class="form-select" name="uf">
            <option value="">—</option>
            {% for uf in UFS %}<option value="{{ uf }}">{{ uf }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Vigência</label>
          <input class="form-control" type="date" name="data_vigencia">
        </div>
        <div class="col-md-4">
          <label class="form-label">Arquivo (.csv/.xlsx)</label>
          <input class="form-control" type="file" name="arquivo" accept=".csv,.xlsx" required>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="substituir" id="dtp_subst">
            <label class="form-check-label" for="dtp_subst">Substituir existentes</label>
          </div>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Importar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12">
    <div class="card p-3" id="imp-cbhpm">
      <h6 class="mb-3">Importar: CBHPM</h6>
      <form method="post" action="{{ url_for('importar_cbhpm') }}" enctype="multipart/form-data" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Operadora</label>
          <select class="form-select" name="operadora_id" required>
            <option value="" disabled selected>Selecione…</option>
            {% for op in operadoras %}<option value="{{ op.id }}">{{ op.nome }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Nome da Tabela (ex.: CBHPM 2023)</label>
          <input class="form-control" name="nome_tabela" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">UF</label>
          <select class="form-select" name="uf">
            <option value="">—</option>
            {% for uf in UFS %}<option value="{{ uf }}">{{ uf }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Vigência</label>
          <input class="form-control" type="date" name="data_vigencia">
        </div>
        <div class="col-md-6">
          <label class="form-label">Arquivo (.csv/.xlsx)</label>
          <input class="form-control" type="file" name="arquivo" accept=".csv,.xlsx" required>
        </div>
        <div class="col-md-6 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="substituir" id="cbhpm_subst">
            <label class="form-check-label" for="cbhpm_subst">Substituir existente com o mesmo nome</label>
          </div>
        </div>
        <div class="col-12">
          <div class="small muted">Colunas aceitas: Código, Procedimento, Porte, Fração Porte, Valor Porte, Total Porte, Incidências, Filme, Total Filme, UCO, Total UCO, Porte Anestésico, Valor Porte Anestésico, Total Porte Anestésico, Nº Auxiliares, Totais Auxiliares, Subtotal, etc.</div>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Importar CBHPM</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12">
    <div class="card p-3" id="imp-porte">
      <h6 class="mb-3">Importar: Tabela de Porte</h6>
      <form method="post" action="{{ url_for('importar_porte') }}" enctype="multipart/form-data" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Operadora</label>
          <select class="form-select" name="operadora_id" required>
            <option value="" disabled selected>Selecione…</option>
            {% for op in operadoras %}<option value="{{ op.id }}">{{ op.nome }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Nome da Tabela (ex.: Porte 2023)</label>
          <input class="form-control" name="nome_tabela" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">UF</label>
          <select class="form-select" name="uf">
            <option value="">—</option>
            {% for uf in UFS %}<option value="{{ uf }}">{{ uf }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Vigência</label>
          <input class="form-control" type="date" name="data_vigencia">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Arquivo (.csv/.xlsx) — colunas: PORTE, VALOR</label>
          <input class="form-control" type="file" name="arquivo" accept=".csv,.xlsx" required>
        </div>
        <div class="col-12 col-md-6 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="substituir" id="porte_subst">
            <label class="form-check-label" for="porte_subst">Substituir existente</label>
          </div>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Importar Porte</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12">
    <div class="card p-3" id="imp-porte-an">
      <h6 class="mb-3">Importar: Porte Anestésico</h6>
      <form method="post" action="{{ url_for('importar_porte_anestesico') }}" enctype="multipart/form-data" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Operadora</label>
          <select class="form-select" name="operadora_id" required>
            <option value="" disabled selected>Selecione…</option>
            {% for op in operadoras %}<option value="{{ op.id }}">{{ op.nome }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Nome da Tabela (ex.: Porte AN 2023)</label>
          <input class="form-control" name="nome_tabela" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">UF</label>
          <select class="form-select" name="uf">
            <option value="">—</option>
            {% for uf in UFS %}<option value="{{ uf }}">{{ uf }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Vigência</label>
          <input class="form-control" type="date" name="data_vigencia">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Arquivo (.csv/.xlsx) — colunas: PORTE AN, VALOR</label>
          <input class="form-control" type="file" name="arquivo" accept=".csv,.xlsx" required>
        </div>
        <div class="col-12 col-md-6 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="substituir" id="portean_subst">
            <label class="form-check-label" for="portean_subst">Substituir existente</label>
          </div>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Importar Porte AN</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12">
    <div class="card p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th><th>Nome</th><th>Operadora</th><th>Prestador</th><th>Tipo</th><th>UF</th><th>Vigência</th><th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tabelas %}
            <tr>
              <td>{{ t.id }}</td>
              <td>{{ t.nome }}</td>
              <td>{{ t.operadora.nome if t.operadora else '-' }}</td>
              <td>{{ t.prestador or 'Vários' }}</td>
              <td>{{ t.tipo_tabela or '-' }}</td>
              <td>{{ t.uf or '-' }}</td>
              <td>{{ t.data_vigencia|date_br }}</td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('tabela_itens', tid=t.id) }}">Ver Itens</a>
                <form method="post" action="{{ url_for('tabela_excluir', tid=t.id) }}" class="d-inline" onsubmit="return confirm('Excluir a tabela {{ t.nome }}? Esta ação não pode ser desfeita.');">
                  <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-secondary py-4">Nenhuma tabela cadastrada</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  const tableBody = document.getElementById('jobsTableBody');
  const summary = document.getElementById('jobsSummary');
  const refreshBtn = document.getElementById('refreshJobsBtn');
  if(!tableBody || !summary) { return; }

  let refreshTimer = null;

  function escapeHtml(str){
    const map = {"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"};
    return (str || '').replace(/[&<>"']/g, ch => map[ch] || ch);
  }

  function formatDate(value){
    if(!value) { return '—'; }
    const date = new Date(value.replace(' ', 'T'));
    if(Number.isNaN(date.getTime())) { return escapeHtml(value); }
    return date.toLocaleString('pt-BR');
  }

  function renderStatus(status){
    const map = {
      'PENDING': {label: 'Pendente', cls: 'bg-secondary'},
      'RUNNING': {label: 'Processando', cls: 'bg-info'},
      'SUCCESS': {label: 'Concluído', cls: 'bg-success'},
      'FAILED': {label: 'Falhou', cls: 'bg-danger'},
    };
    const meta = map[status] || {label: status || '—', cls: 'bg-secondary'};
    return `<span class="badge ${meta.cls}">${meta.label}</span>`;
  }

  async function loadJobs(){
    try{
      const response = await fetch('{{ url_for('insumos_import_jobs_list') }}');
      if(!response.ok){ throw new Error('Falha ao consultar importações.'); }
      const payload = await response.json();
      const items = payload.items || [];
      if(!items.length){
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Nenhuma importação agendada.</td></tr>';
        summary.textContent = 'Nenhuma importação recente.';
        return;
      }
      const rows = items.map(item => {
        const protocolo = escapeHtml((item.id || '').slice(0, 8));
        const origem = escapeHtml(item.origem || '—');
        const versao = escapeHtml(item.versao || '—');
        const ufs = (item.uf_list || []).join(', ') || '—';
        const statusHtml = renderStatus(item.status);
        const mensagem = escapeHtml(item.message || '—');
        const totalTime = item.metrics?.timings?.total;
        const totalLabel = totalTime ? `${Number(totalTime).toFixed(2)}s` : '—';
        const updatedAt = item.finished_at || item.started_at || item.created_at;
        return `
          <tr>
            <td class="text-muted">${protocolo}</td>
            <td>${origem}</td>
            <td>${versao}</td>
            <td>${escapeHtml(ufs)}</td>
            <td>${statusHtml}</td>
            <td>${escapeHtml(totalLabel)}</td>
            <td>${mensagem}</td>
            <td>${formatDate(updatedAt)}</td>
          </tr>`;
      }).join('');
      tableBody.innerHTML = rows;
      summary.textContent = `Atualizado às ${new Date().toLocaleTimeString('pt-BR')}`;
    } catch(err){
      tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-3">Erro ao carregar importações.</td></tr>';
      summary.textContent = err.message;
    }
  }

  function scheduleRefresh(){
    if(refreshTimer){
      clearInterval(refreshTimer);
    }
    refreshTimer = setInterval(loadJobs, 15000);
  }

  async function validateFilePreview(file, form){
    const errors = [];
    try{
      const preview = await file.slice(0, 65536).text();
      const lines = preview.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
      if(!lines.length){
        errors.push('Arquivo vazio ou não foi possível ler o cabeçalho.');
        return errors;
      }
      const formatSelect = form.querySelector('select[name="format"]');
      const formatValue = formatSelect ? (formatSelect.value || '').toLowerCase() : '';
      const delimiterInput = form.querySelector('input[name="delimiter"]');
      const delimiterValue = delimiterInput ? (delimiterInput.value || ';') : ';';
      if(formatValue === 'delimited'){
        const header = lines[0];
        const columns = header.split(delimiterValue);
        if(columns.length <= 3){
          errors.push('Cabeçalho parece inválido para o delimitador informado.');
        }
      }
    } catch(err){
      errors.push('Falha ao analisar o arquivo: ' + (err && err.message ? err.message : err));
    }
    return errors;
  }

  function setupImportForms(){
    const forms = document.querySelectorAll('form[data-import-form]');
    forms.forEach(form => {
      const fileInput = form.querySelector('input[type="file"][name="arquivo"]');
      const submitBtn = form.querySelector('button[type="submit"]');
      const progressWrap = form.querySelector('[data-progress]');
      const progressBar = progressWrap ? progressWrap.querySelector('.progress-bar') : null;
      const messageBox = form.querySelector('.import-message');

      function resetFeedback(){
        if(progressWrap){
          progressWrap.classList.add('d-none');
        }
        if(progressBar){
          progressBar.style.width = '0%';
        }
        if(messageBox){
          messageBox.textContent = '';
          messageBox.classList.remove('text-danger', 'text-success', 'text-warning');
          messageBox.classList.add('text-muted');
        }
      }

      function setMessage(type, text){
        if(!messageBox){ return; }
        messageBox.textContent = text;
        messageBox.classList.remove('text-muted', 'text-danger', 'text-success', 'text-warning');
        if(type === 'error'){
          messageBox.classList.add('text-danger');
        } else if(type === 'success'){
          messageBox.classList.add('text-success');
        } else if(type === 'warning'){
          messageBox.classList.add('text-warning');
        } else {
          messageBox.classList.add('text-muted');
        }
      }

      form.addEventListener('submit', async function(evt){
        evt.preventDefault();
        resetFeedback();

        if(!fileInput || !fileInput.files || !fileInput.files.length){
          setMessage('error', 'Selecione um arquivo para importar.');
          return;
        }

        const file = fileInput.files[0];
        if(file.size > 150 * 1024 * 1024){
          setMessage('warning', 'Arquivo muito grande; o envio pode levar alguns minutos.');
        }

        if(submitBtn){ submitBtn.disabled = true; }

        const validationErrors = await validateFilePreview(file, form);
        if(validationErrors.length){
          if(submitBtn){ submitBtn.disabled = false; }
          setMessage('error', validationErrors.join(' '));
          return;
        }

        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();
        xhr.open('POST', form.action);
        xhr.responseType = 'text';
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        if(progressWrap){
          progressWrap.classList.remove('d-none');
        }

        xhr.upload.addEventListener('progress', function(event){
          if(progressBar && event.lengthComputable){
            const percent = Math.round((event.loaded / event.total) * 100);
            progressBar.style.width = percent + '%';
          }
        });

        xhr.addEventListener('readystatechange', function(){
          if(xhr.readyState !== XMLHttpRequest.DONE){
            return;
          }
          if(submitBtn){ submitBtn.disabled = false; }

          const contentType = xhr.getResponseHeader('Content-Type') || '';
          let payload = null;
          if(contentType.includes('application/json')){
            try {
              payload = JSON.parse(xhr.responseText || '{}');
            } catch(_err){ payload = null; }
          }

          if(xhr.status >= 200 && xhr.status < 400){
            const msg = payload && payload.message ? payload.message : 'Importação enviada. Processando...';
            const type = payload && payload.status === 'error' ? 'error' : 'success';
            setMessage(type, msg);
            loadJobs();
          } else {
            const errorMsg = payload && payload.message
              ? payload.message
              : (xhr.responseText || xhr.statusText || 'Falha no envio.').trim();
            setMessage('error', errorMsg);
          }
        });

        try{
          xhr.send(formData);
        } catch(err){
          if(submitBtn){ submitBtn.disabled = false; }
          setMessage('error', 'Erro ao enviar o arquivo: ' + (err && err.message ? err.message : err));
        }
      });
    });
  }

  refreshBtn?.addEventListener('click', function(){
    loadJobs();
  });

  document.addEventListener('visibilitychange', function(){
    if(document.hidden){
      if(refreshTimer){
        clearInterval(refreshTimer);
        refreshTimer = null;
      }
    } else {
      loadJobs();
      scheduleRefresh();
    }
  });

  loadJobs();
  scheduleRefresh();
  setupImportForms();

  document.querySelectorAll('form[data-fill-label]').forEach(form => {
    const fileInput = form.querySelector('input[type="file"][name="arquivo"]');
    const labelInput = form.querySelector('input[name="arquivo_label"]');
    if(!fileInput || !labelInput){ return; }

    function slugify(name){
      return name
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '')
        .slice(0, 60);
    }

    fileInput.addEventListener('change', function(){
      if(labelInput.value){ return; }
      const full = this.value.split('\\').pop().split('/').pop();
      const base = full.includes('.') ? full.substring(0, full.lastIndexOf('.')) : full;
      const suggestion = slugify(base);
      if(suggestion){
        labelInput.value = suggestion;
      }
    });
  });
})();
</script>
{% endblock %}
