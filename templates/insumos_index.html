{% extends 'base.html' %}

{% block title %}Simpro & Brasíndice{% endblock %}
{% block page_title %}Simpro & Brasíndice{% endblock %}

{% block content %}
<div class="row gy-3">
  <div class="col-12 col-xl-6">
    <div class="border rounded-3 p-3 h-100 bg-white">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="text-uppercase text-muted small">Brasíndice</div>
          <h6 class="mb-0">{{ bras_summary.total | default(0) }} itens</h6>
        </div>
        <i class="bi bi-collection text-primary fs-3"></i>
      </div>
      <dl class="row mb-0 small">
        <dt class="col-5 text-muted">Versão mais recente</dt>
        <dd class="col-7">{{ bras_summary.latest_version or '—' }}</dd>
        <dt class="col-5 text-muted">Atualizado em</dt>
        <dd class="col-7">{{ bras_summary.last_updated.strftime('%d/%m/%Y %H:%M') if bras_summary.last_updated else '—' }}</dd>
        <dt class="col-5 text-muted">Data referência</dt>
        <dd class="col-7">{{ bras_summary.last_data_ref.strftime('%d/%m/%Y') if bras_summary.last_data_ref else '—' }}</dd>
      </dl>
    </div>
  </div>
  <div class="col-12 col-xl-6">
    <div class="border rounded-3 p-3 h-100 bg-white">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="text-uppercase text-muted small">SIMPRO</div>
          <h6 class="mb-0">{{ simpro_summary.total | default(0) }} itens</h6>
        </div>
        <i class="bi bi-boxes text-success fs-3"></i>
      </div>
      <dl class="row mb-0 small">
        <dt class="col-5 text-muted">Versão mais recente</dt>
        <dd class="col-7">{{ simpro_summary.latest_version or '—' }}</dd>
        <dt class="col-5 text-muted">Atualizado em</dt>
        <dd class="col-7">{{ simpro_summary.last_updated.strftime('%d/%m/%Y %H:%M') if simpro_summary.last_updated else '—' }}</dd>
        <dt class="col-5 text-muted">Data referência</dt>
        <dd class="col-7">{{ simpro_summary.last_data_ref.strftime('%d/%m/%Y') if simpro_summary.last_data_ref else '—' }}</dd>
      </dl>
    </div>
  </div>
</div>

{% if is_admin %}
<div class="d-flex justify-content-end mt-3">
  <a class="btn btn-outline-primary" href="{{ url_for('insumos_aliquotas') }}">
    <i class="bi bi-sliders"></i> Ajustar alíquotas
  </a>
</div>
{% endif %}

<div class="border rounded-3 p-3 bg-white mt-4">
  <form id="insumoFilters" class="row gy-3">
    <div class="col-12 col-md-4">
      <label class="form-label">Buscar termo</label>
      <input type="text" class="form-control" id="fTermo" placeholder="Descrição, fabricante, código" autocomplete="off">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Origem</label>
      <select id="fOrigem" class="form-select">
        <option value="">Todas</option>
        <option value="BRAS">Brasíndice</option>
        <option value="SIMPRO">SIMPRO</option>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Versão</label>
      <select id="fVersao" class="form-select">
        <option value="">Todas</option>
        {% for ver in versions %}
        <option value="{{ ver }}">{{ ver }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">TUSS</label>
      <input type="text" class="form-control" id="fTuss" autocomplete="off">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">TISS</label>
      <input type="text" class="form-control" id="fTiss" autocomplete="off">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">ANVISA</label>
      <input type="text" class="form-control" id="fAnvisa" autocomplete="off">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">UF</label>
      <select class="form-select" id="fUf">
        <option value="">Selecione…</option>
        {% for uf in UFS %}
        <option value="{{ uf }}">{{ uf }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Alíquota (%)</label>
      <input type="text" class="form-control" id="fAliquota" autocomplete="off" placeholder="ex.: 18 ou 18,5">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Fabricante</label>
      <input type="text" class="form-control" id="fFabricante" autocomplete="off">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Itens por página</label>
      <select id="fPerPage" class="form-select">
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
        <option value="250">250</option>
      </select>
    </div>
    <div class="col-12 col-lg-3 align-self-end">
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-fill" id="btnBuscar">
          <i class="bi bi-search me-1"></i>Buscar
        </button>
        <button type="button" class="btn btn-outline-secondary" id="btnLimpar">
          <i class="bi bi-eraser"></i>
        </button>
      </div>
    </div>
  </form>

  <div class="mt-4">
    <div class="d-flex justify-content-between flex-wrap gap-2 mb-2">
      <div id="resultadoResumo" class="small text-muted">Preencha os filtros e clique em buscar.</div>
      <div class="btn-group" role="group" aria-label="Paginação">
        <button class="btn btn-outline-secondary btn-sm" id="paginacaoAnterior" disabled><i class="bi bi-chevron-left"></i></button>
        <button class="btn btn-outline-secondary btn-sm" id="paginacaoProximo" disabled><i class="bi bi-chevron-right"></i></button>
      </div>
    </div>

    <div class="table-responsive position-relative">
      <div id="resultadoLoading" class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75 d-none" style="pointer-events:none;">
        <div class="spinner-border" role="status"><span class="visually-hidden">Carregando…</span></div>
      </div>
      <table class="table table-clean align-middle mb-0" id="resultadoTabela">
        <thead>
          <tr>
            <th style="width:90px;">Origem</th>
            <th style="width:140px;">Códigos</th>
            <th>Descrição</th>
            <th style="width:130px;" class="text-end">PMC</th>
            <th style="width:130px;" class="text-end">PFB</th>
            <th style="width:90px;" class="text-center">UF</th>
            <th style="width:130px;" class="text-end">Alíquota</th>
            <th style="width:150px;">Versão</th>
            <th style="width:110px;">Atualização</th>
            <th style="width:90px;"></th>
          </tr>
        </thead>
        <tbody id="resultadoBody">
          <tr><td colspan="10" class="text-center text-muted py-4">Nenhuma busca realizada.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if is_admin %}
<div class="alert alert-info mt-4" role="alert">
  As importações de Brasíndice e SIMPRO agora estão centralizadas em <strong>Gerenciar Tabelas</strong>.
  Vá até a seção "Insumos" para carregar novos arquivos.
</div>
{% endif %}

<div class="modal fade" id="detalheModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalhes do item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="detalheConteudo"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  const form = document.getElementById('insumoFilters');
  const tbody = document.getElementById('resultadoBody');
  const resumo = document.getElementById('resultadoResumo');
  const loading = document.getElementById('resultadoLoading');
  const btnPrev = document.getElementById('paginacaoAnterior');
  const btnNext = document.getElementById('paginacaoProximo');
  const perPageSelect = document.getElementById('fPerPage');
  const btnLimpar = document.getElementById('btnLimpar');
  const modalEl = document.getElementById('detalheModal');
  const modalBody = document.getElementById('detalheConteudo');
  let modal;
  if (modalEl){ modal = new bootstrap.Modal(modalEl); }

  let page = 1;
  let totalPages = 0;

  function toggleLoading(state){
    if(state){
      loading.classList.remove('d-none');
    } else {
      loading.classList.add('d-none');
    }
  }

  function escapeHtml(str){
    return (str || '').replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch] || ch));
  }

  function formatMoney(value){
    if(value === null || value === undefined || value === '') return '—';
    const num = Number(value);
    if(Number.isNaN(num)) return value;
    return num.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:4});
  }

  function formatAliquota(value){
    if(value === null || value === undefined || value === '') return '—';
    const num = Number(value);
    if(Number.isNaN(num)) return value;
    return num.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:4}) + '%';
  }

  const TIMELINE_MONTHS = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

  function toNumber(value){
    if(value === null || value === undefined || value === '') return null;
    const num = Number(value);
    return Number.isFinite(num) ? num : null;
  }

  function formatPercent(value){
    const num = toNumber(value);
    if(num === null){
      return '—';
    }
    return `${num.toLocaleString('pt-BR', {minimumFractionDigits:0, maximumFractionDigits:1})}%`;
  }

  function parseBrDate(value){
    if(!value || typeof value !== 'string') return null;
    const parts = value.split('/');
    if(parts.length === 3){
      const [dia, mes, ano] = parts.map(part => parseInt(part, 10));
      if(!Number.isNaN(dia) && !Number.isNaN(mes) && !Number.isNaN(ano)){
        const date = new Date(ano < 100 ? 2000 + ano : ano, mes - 1, dia);
        return Number.isNaN(date.getTime()) ? null : date;
      }
    }
    const timestamp = Date.parse(value);
    return Number.isNaN(timestamp) ? null : new Date(timestamp);
  }

  function formatTimelineDate(row){
    const date = parseBrDate(row.data_atualizacao);
    if(date){
      const monthLabel = TIMELINE_MONTHS[date.getMonth()] || '';
      const yearLabel = String(date.getFullYear()).slice(-2);
      return `${monthLabel}/${yearLabel}`;
    }
    if(row.versao){
      return String(row.versao);
    }
    return row.uf || '—';
  }

  function pickPriceInfo(row){
    const candidates = [
      { value: row.preco_pmc, label: 'PMC' },
      { value: row.preco_pfb, label: 'PFB' },
      { value: row.preco, label: 'Preço' },
    ];
    for(const entry of candidates){
      const num = toNumber(entry.value);
      if(num !== null){
        return {
          label: entry.label,
          num,
          formatted: formatMoney(num),
        };
      }
    }
    return { label: null, num: null, formatted: null };
  }

  function buildTimelineEvents(rows, targetUf){
    if(!Array.isArray(rows) || !rows.length){
      return [];
    }
    const normalizedUf = (targetUf || '').toUpperCase();
    let relevant = rows.filter(row => {
      const ufValue = (row.uf || '').toUpperCase();
      return !normalizedUf || ufValue === normalizedUf;
    });
    if(!relevant.length){
      relevant = rows.slice();
    }
    const sorted = relevant.slice().sort((a, b) => {
      const dateA = parseBrDate(a.data_atualizacao);
      const dateB = parseBrDate(b.data_atualizacao);
      if(dateA && dateB){
        return dateA.getTime() - dateB.getTime();
      }
      if(dateA) return -1;
      if(dateB) return 1;
      const versaoA = a.versao || '';
      const versaoB = b.versao || '';
      return versaoA.localeCompare(versaoB);
    });
    if(!sorted.length){
      return [];
    }

    const events = [];
    let prevInfo = null;
    let prevRow = null;
    sorted.forEach((row, index) => {
      const info = pickPriceInfo(row);
      if(index === 0){
        if(info.num !== null){
          events.push({
            title: formatTimelineDate(row),
            text: `${info.label || 'Preço'} inicial R$ ${info.formatted}`,
          });
        }
      } else if(info.num !== null){
        let added = false;
        if(prevInfo && prevInfo.num !== null && prevInfo.num !== 0){
          const diff = info.num - prevInfo.num;
          const pct = diff / prevInfo.num;
          if(Number.isFinite(pct) && Math.abs(pct) >= 0.1){
            const directionUp = pct > 0;
            const directionLabel = directionUp ? 'Alta' : 'Queda';
            events.push({
              title: formatTimelineDate(row),
              text: `${directionLabel} de ${(Math.abs(pct) * 100).toFixed(1)}% -> ${info.label || 'Preço'} R$ ${info.formatted}`,
            });
            added = true;
          }
        }
        const versionChanged = prevRow && row.versao && row.versao !== prevRow.versao;
        if(!added && versionChanged){
          events.push({
            title: formatTimelineDate(row),
            text: `Versão ${row.versao} - ${info.label || 'Preço'} R$ ${info.formatted}`,
          });
          added = true;
        }
        if(!added && index === sorted.length - 1){
          events.push({
            title: formatTimelineDate(row),
            text: `${info.label || 'Preço'} atual R$ ${info.formatted}`,
          });
        }
      }
      prevInfo = info;
      prevRow = row;
    });

    const unique = [];
    const seen = new Set();
    events.forEach(evt => {
      const key = `${evt.title}|${evt.text}`;
      if(seen.has(key)) return;
      seen.add(key);
      unique.push(evt);
    });
    return unique;
  }

  function getFilters(){
    const data = new URLSearchParams();
    const termo = document.getElementById('fTermo').value.trim();
    const origem = document.getElementById('fOrigem').value;
    const versao = document.getElementById('fVersao').value;
    const tuss = document.getElementById('fTuss').value.trim();
    const tiss = document.getElementById('fTiss').value.trim();
    const anvisa = document.getElementById('fAnvisa').value.trim();
    const uf = document.getElementById('fUf').value.trim();
    const aliquota = document.getElementById('fAliquota').value.trim();
    const fabricante = document.getElementById('fFabricante').value.trim();
    data.set('page', page);
    data.set('per_page', perPageSelect.value || '50');
    if(termo) data.set('q', termo);
    if(origem) data.set('origem', origem);
    if(versao) data.set('versao_tabela', versao);
    if(tuss) data.set('tuss', tuss);
    if(tiss) data.set('tiss', tiss);
    if(anvisa) data.set('anvisa', anvisa);
    if(uf) data.set('uf_referencia', uf);
    if(aliquota) data.set('aliquota', aliquota);
    if(fabricante) data.set('fabricante', fabricante);
    return data;
  }

  function renderRows(items){
    if(!items.length){
      tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">Nenhum item encontrado.</td></tr>';
      return;
    }
    const rows = items.map(item => {
      const atualizacao = item.updated_at ? item.updated_at.replace('T',' ') : '—';
      const dataRef = item.data_atualizacao || '—';
      const origem = escapeHtml(item.origem);
      const ufDisplay = item.uf_referencia || '';
      const ufCodes = Array.isArray(item.uf_referencia_codes) ? item.uf_referencia_codes : [];
      const uf = escapeHtml(ufDisplay || '—');
      const ufSel = document.getElementById('fUf').value.trim();
      const ufForDetail = ufSel || (ufCodes.length === 1 ? ufCodes[0] : (ufCodes[0] || ''));
      const aliquota = formatAliquota(item.aliquota);
      return `
        <tr>
          <td class="fw-semibold">${origem}</td>
          <td>
            <div class="small fw-semibold">${escapeHtml(item.tuss || '—')}</div>
            <div class="small text-muted">TISS: ${escapeHtml(item.tiss || '—')}</div>
            <div class="small text-muted">ANVISA: ${escapeHtml(item.anvisa || '—')}</div>
          </td>
          <td>
            <div class="fw-semibold">${escapeHtml(item.descricao || '')}</div>
            <div class="small text-muted">${escapeHtml(item.fabricante || '')}</div>
          </td>
          <td class="text-end">${formatMoney(item.preco_pmc)}</td>
          <td class="text-end">${formatMoney(item.preco_pfb)}</td>
          <td class="text-center">${uf}</td>
          <td class="text-end">${aliquota}</td>
          <td>
            <div>${escapeHtml(item.versao_tabela || '—')}</div>
            <div class="small text-muted">Ref.: ${escapeHtml(dataRef)}</div>
          </td>
          <td class="small">${atualizacao}</td>
          <td class="text-end">
            <button type="button" class="btn btn-light btn-sm border visualizar-item" data-origem="${origem}" data-id="${item.item_id}" data-uf="${escapeHtml(ufForDetail)}">
              <i class="bi bi-eye"></i>
            </button>
          </td>
        </tr>`;
    }).join('');
    tbody.innerHTML = rows;
    // Delegated listener below cuida do clique, não precisamos registrar aqui.
  }

  async function carregar(){
    const origemSel = document.getElementById('fOrigem').value;
    const ufSel = document.getElementById('fUf').value.trim();
    if(!ufSel){
      resumo.textContent = 'Informe uma UF antes de buscar.';
      tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">Selecione uma UF para consultar.</td></tr>';
      btnPrev.disabled = true;
      btnNext.disabled = true;
      return;
    }

    const params = getFilters();
    toggleLoading(true);
    try{
      const response = await fetch(`{{ url_for('insumos_search') }}?${params.toString()}`);
      if(!response.ok){
        throw new Error('Falha ao buscar itens.');
      }
      const payload = await response.json();
      const items = payload.items || [];
      const pagination = payload.pagination || {};
      const total = Number(pagination.total || 0);
      page = Number(pagination.page || 1);
      totalPages = Number(pagination.pages || 0);
      renderRows(items);

      if(total > 0){
        const start = ((page - 1) * Number(pagination.per_page || 0)) + 1;
        const end = start + items.length - 1;
        resumo.textContent = `Exibindo ${start}-${end} de ${total} itens`;
      } else {
        resumo.textContent = 'Nenhum item encontrado para os filtros informados.';
      }
      btnPrev.disabled = page <= 1;
      btnNext.disabled = !totalPages || page >= totalPages;
    } catch(err){
      resumo.textContent = err.message;
          tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger py-4">Não foi possível carregar os itens.</td></tr>';
    } finally {
      toggleLoading(false);
    }
  }

  form.addEventListener('submit', function(evt){
    evt.preventDefault();
    page = 1;
    carregar();
  });

  perPageSelect.addEventListener('change', function(){
    page = 1;
    carregar();
  });

  btnPrev.addEventListener('click', function(evt){
    evt.preventDefault();
    if(page > 1){
      page -= 1;
      carregar();
    }
  });

  btnNext.addEventListener('click', function(evt){
    evt.preventDefault();
    if(totalPages && page < totalPages){
      page += 1;
      carregar();
    }
  });

  btnLimpar.addEventListener('click', function(){
    form.reset();
    document.getElementById('fPerPage').value = '50';
  });

  tbody.addEventListener('click', async function(evt){
    const btn = evt.target.closest('.visualizar-item');
    if(!btn){ return; }
    const origem = btn.getAttribute('data-origem');
    const itemId = btn.getAttribute('data-id');
    const ufItem = btn.getAttribute('data-uf') || '';
    if(!origem || !itemId){ return; }
    try{
      btn.disabled = true;
      const queryUf = ufItem ? `?uf=${encodeURIComponent(ufItem)}` : '';
      const res = await fetch(`/insumos/${encodeURIComponent(origem)}/${itemId}${queryUf}`);
      if(!res.ok){ throw new Error('Item não encontrado.'); }
      const data = await res.json();
      const entries = [
        ['Origem', data.origem],
        ['TUSS', data.tuss || '—'],
        ['TISS', data.tiss || '—'],
        ['ANVISA', data.anvisa || '—'],
        ['Descrição', data.descricao || ''],
        ['Fabricante', data.fabricante || '—'],
        ['PMC', formatMoney(data.preco_pmc ?? data.preco)],
        ['PFB', formatMoney(data.preco_pfb ?? data.preco)],
        ['Alíquota', formatAliquota(data.aliquota)],
        ['UF', data.uf_referencia || '—'],
        ['Versão', data.versao_tabela || '—'],
        ['Data ref.', data.data_atualizacao || '—'],
        ['Criado em', data.created_at ? data.created_at.replace('T',' ') : '—'],
        ['Atualizado em', data.updated_at ? data.updated_at.replace('T',' ') : '—']
      ];
      const historico = Array.isArray(data.historico) ? data.historico : [];
      const impactoClinico = Array.isArray(data.impacto_clinico) ? data.impacto_clinico : [];
      const entriesMarkup = entries.map(([label, value]) => `
        <dt class="col-4 text-muted small">${escapeHtml(label)}</dt>
        <dd class="col-8 small">${escapeHtml(String(value))}</dd>
      `).join('');
      let impactoMarkup = '';
      if (impactoClinico.length) {
        const cards = impactoClinico.map(item => {
          const freq = toNumber(item.frequencia_relativa);
          const freqLabel = freq !== null ? formatPercent(freq * 100) : null;
          const custoProcedimento = item.custo_procedimento !== null && item.custo_procedimento !== undefined ? formatMoney(item.custo_procedimento) : null;
          const headerParts = [];
          if(item.procedimento_codigo){ headerParts.push(item.procedimento_codigo); }
          if(item.procedimento_descricao){ headerParts.push(item.procedimento_descricao); }
          const header = headerParts.length ? headerParts.join(' · ') : 'Procedimento associado';
          const drgInfo = item.drg ? `DRG ${escapeHtml(item.drg)}` : '';
          const metrics = [
            freqLabel ? `Frequência estimada: ${freqLabel}` : '',
            custoProcedimento ? `Custo médio: R$ ${custoProcedimento}` : '',
            drgInfo,
          ].filter(Boolean).join(' · ');
          const variacoes = Array.isArray(item.variacoes) ? item.variacoes : [];
          const variacoesMarkup = variacoes.length ? `
            <div class="border rounded p-2 bg-light mt-2">
              ${variacoes.map(v => {
                const pctLabel = formatPercent(v.percentual);
                const deltaUnit = formatMoney(v.delta_unitario);
                const deltaProc = v.delta_procedimento ? formatMoney(v.delta_procedimento) : '—';
                return `
                  <div class="d-flex justify-content-between small">
                    <span>${escapeHtml(pctLabel)}</span>
                    <span>Δ Unidade: R$ ${escapeHtml(deltaUnit)}${deltaProc !== '—' ? ` · Δ Procedimento: R$ ${escapeHtml(deltaProc)}` : ''}</span>
                  </div>
                `;
              }).join('')}
            </div>
          ` : '';
          const substitutos = Array.isArray(item.substitutos) ? item.substitutos : [];
          const substitutosMarkup = substitutos.length ? `
            <div class="d-flex flex-wrap gap-2 mt-2">
              ${substitutos.map(label => `<span class="badge bg-secondary-subtle text-secondary">${escapeHtml(label)}</span>`).join('')}
            </div>
          ` : '';
          const narrativa = item.narrativa ? `<p class="small mb-0 mt-2">${escapeHtml(item.narrativa)}</p>` : '';
          return `
            <div class="border rounded p-3 bg-white">
              <div class="fw-semibold">${escapeHtml(header)}</div>
              ${metrics ? `<div class="text-muted small mt-1">${metrics}</div>` : ''}
              ${variacoesMarkup}
              ${substitutosMarkup}
              ${narrativa}
            </div>
          `;
        }).join('');
        impactoMarkup = `
          <hr class="my-3">
          <div class="mb-3">
            <h6 class="mb-2 d-flex align-items-center gap-2">Impacto clínico <span class="badge rounded-pill text-bg-dark">ADM</span></h6>
            <div class="d-flex flex-column gap-3">
              ${cards}
            </div>
          </div>
        `;
      }
      let historicoMarkup = '';
      if (historico.length) {
        const targetUf = (data.uf_filtro || data.uf_referencia || '').toUpperCase();
        const timelineEvents = buildTimelineEvents(historico, targetUf);
        const timelineMarkup = timelineEvents.length
          ? `
            <div class="d-flex flex-wrap gap-2">
              ${timelineEvents.map(evt => `
                <div class="border rounded px-3 py-2 bg-light small">
                  <div class="fw-semibold text-uppercase text-muted">${escapeHtml(evt.title)}</div>
                  <div>${escapeHtml(evt.text)}</div>
                </div>
              `).join('')}
            </div>
          `
          : '<p class="text-muted small mb-0">Nenhum evento relevante detectado para esta série.</p>';
        const rows = historico.map(item => {
          const precoPmc = formatMoney(item.preco_pmc ?? item.preco);
          const precoPfb = formatMoney(item.preco_pfb ?? item.preco);
          const aliquotaFmt = formatAliquota(item.aliquota);
          const dataAtualizacao = escapeHtml(item.data_atualizacao || '—');
          const versao = escapeHtml(item.versao || '—');
          const uf = escapeHtml(item.uf || '—');
          return `
            <tr>
              <td class="small">${versao}</td>
              <td class="small">${uf}</td>
              <td class="small text-end">${escapeHtml(precoPmc)}</td>
              <td class="small text-end">${escapeHtml(precoPfb)}</td>
              <td class="small text-end">${escapeHtml(aliquotaFmt)}</td>
              <td class="small text-end">${dataAtualizacao}</td>
            </tr>
          `;
        }).join('');
        historicoMarkup = `
          <hr class="my-3">
          <div class="mb-3">
            <h6 class="mb-2">Linha do tempo</h6>
            ${timelineMarkup}
          </div>
          <div>
            <h6 class="mb-2">Histórico por versão/UF</h6>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th class="small">Versão</th>
                    <th class="small">UF</th>
                    <th class="small text-end">PMC</th>
                    <th class="small text-end">PFB</th>
                    <th class="small text-end">Alíquota</th>
                    <th class="small text-end">Atualização</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      modalBody.innerHTML = `
        <dl class="row g-2 mb-0">
          ${entriesMarkup}
        </dl>
        ${impactoMarkup}
        ${historicoMarkup || '<p class="text-muted small mb-0 mt-3">Histórico por versão/UF indisponível.</p>'}
      `;
      modal.show();
    } catch(err){
      alert(err.message);
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>
{% endblock %}
