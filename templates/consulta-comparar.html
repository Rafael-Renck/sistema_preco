{% extends 'base.html' %}
{% set show_tuss_rol = session_feature_tuss_rol or session_perfil == 'adm' %}

{% block title %}Consulta & Comparar{% endblock %}
{% block page_title %}Consulta &amp; Comparar{% endblock %}

{% block page_css %}
<style>
  /* Esconde a busca global do topo nesta tela */
  #globalSearch{ display:none !important; }

  :root { --ap-border:#e5e7eb; --ap-muted:#6b7280; --ap-bg-soft:#f8fafc; }
  .section-title{ font-weight:600; margin-bottom:.25rem; letter-spacing:.2px; }
  .soft{ color:var(--ap-muted); font-size:.875rem; }
  .mini-label{ font-size:.8rem; color:var(--ap-muted); }
  .pill{ border:1px solid var(--ap-border); background:#fff; border-radius:999px; padding:.25rem .6rem; font-size:.75rem; }
  .kbd{ border:1px solid var(--ap-border); background:#fff; border-radius:6px; padding:.05rem .35rem; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:.75rem; }

  /* Deixa o SVG do Lucide “transparente” ao clique: evita bugs de evento no ícone */
  .lucide, [data-lucide], .btn svg, .nav-item svg { pointer-events:none; }

  .card-toolbar{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:.5rem .75rem;border-bottom:1px solid var(--ap-border);background:linear-gradient(180deg,rgba(0,0,0,.02),transparent)}
  .btn-icon{display:inline-flex;align-items:center;gap:.35rem}
  .btn-icon i{width:16px;height:16px}

  /* Tabela */
  .table-smart thead th{position:sticky;top:0;z-index:2;background:var(--ap-bg-soft);backdrop-filter:blur(2px)}
  .table-smart tbody td,.table-smart thead th{white-space:nowrap;vertical-align:middle}
  .table-sticky-first td:first-child,.table-sticky-first th:first-child{position:sticky;left:0;z-index:1;background:#fff;box-shadow:1px 0 0 var(--ap-border)}
  .table-hover tbody tr:hover td{background:rgba(32,132,125,.06)}
  .empty{padding:2.5rem 1rem;text-align:center;color:var(--ap-muted)}
  .empty i{width:22px;height:22px;margin-right:.25rem}

  .nav-pills .nav-link{border-radius:999px;padding:.4rem .9rem;font-weight:500}
  .meta{display:flex;flex-wrap:wrap;gap:.4rem .5rem;align-items:center}
  .meta .chip{border:1px solid var(--ap-border);border-radius:999px;padding:.2rem .6rem;font-size:.75rem;background:#fff}
  .check-grid .form-check{padding:.4rem .5rem;border:1px solid var(--ap-border);border-radius:10px;background:#fff}
  .check-grid .form-check.suggested{border-color:#0d9488;box-shadow:0 0 0 1px rgba(13,148,136,.25) inset;background:#f0fdfa}
  .table-smart tbody tr.row-excede td{background:rgba(220,53,69,.08)}
  .table-smart tbody tr.row-excede:hover td{background:rgba(220,53,69,.12)}
  /* === Autocomplete de Procedimentos === */
.ap-picker{ position:relative; }
.ap-input{ padding-right:2.25rem; }
.ap-chips{ display:flex; flex-wrap:wrap; gap:.35rem; margin-bottom:.35rem; }
.ap-chip{
  display:inline-flex; align-items:center; gap:.35rem;
  border:1px solid var(--ap-border); background:#fff; border-radius:999px;
  padding:.15rem .5rem; font-size:.8rem;
}
.ap-chip .ap-x{ cursor:pointer; font-size:1rem; line-height:1; opacity:.7; }
.ap-chip .ap-x:hover{ opacity:1; }
.ap-list{ position:absolute; inset-inline:0; top:100%; z-index:3000; max-height:300px; overflow:auto; }

/* Cada opção: uma linha, altura confortável */
.ap-item{
  display:flex; align-items:center; gap:.5rem;
  padding:.4rem .75rem; cursor:pointer; border-bottom:1px solid var(--ap-border);
}
.ap-item:last-child{ border-bottom:0; }
.ap-item:hover, .ap-item.active{ background:rgba(32,132,125,.08); }

.ap-state{ padding:.5rem .75rem; font-size:.85rem; color:var(--ap-muted); background:#fff; border:1px solid var(--ap-border); border-top:0; }
.ap-hint{border:1px dashed var(--ap-border); background:var(--ap-bg-soft); border-radius:10px; padding:.75rem;}
.ap-hint .mini-label{display:block; font-size:.75rem; text-transform:uppercase; letter-spacing:.05em; margin-bottom:.35rem;}
.ap-hint .badge{padding:.4rem .6rem; font-size:.75rem; border-radius:999px; border:1px solid rgba(13,148,136,.35); color:#067a6f; background:rgba(13,148,136,.12);}
.ap-hint .soft{font-size:.8rem;}
.btn[data-loading="on"] .btn-icon-slot[data-state="icon"],
.btn[data-loading="on"] .btn-icon-slot[data-state="label"]{ opacity:.6; }
.btn[data-loading="on"] .spinner-border{ display:inline-block !important; margin-right:.35rem; }

/* Coluna do código fixa, monoespaçada */
.ap-code{ font-weight:600; font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
  width:120px; flex:0 0 120px; }

/* Descrição em 1 linha com reticências */
  .ap-desc{ flex:1 1 auto; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* Texto auxiliar menor e em cinza (se usar) */
.ap-muted{ color:var(--ap-muted); font-size:.8rem; }

/* Combos de procedimento */
.combo-card{border:1px solid var(--ap-border);border-radius:16px;background:#fff;box-shadow:0 8px 24px rgba(15,23,42,.06);overflow:hidden;}
.combo-card-header{padding:1rem 1.25rem;border-bottom:1px solid var(--ap-border);display:flex;flex-wrap:wrap;align-items:center;gap:1rem;justify-content:space-between;}
.combo-card-header h5{margin:0;font-weight:600;}
.combo-card-body{padding:1.25rem;}
.combo-builder{display:grid;grid-template-columns:1fr;gap:1rem;}
@media(min-width:992px){.combo-builder{grid-template-columns:1.1fr .9fr;}}
.combo-ghost{border:1px dashed var(--ap-border);border-radius:12px;padding:1rem;background:var(--ap-bg-soft);}
.combo-items-list{display:flex;flex-direction:column;gap:.75rem;margin-top:.75rem;}
.combo-item{border:1px solid var(--ap-border);border-radius:12px;padding:.75rem 1rem;background:#fff;display:flex;flex-direction:column;gap:.35rem;}
.combo-item-heading{display:flex;justify-content:space-between;align-items:flex-start;gap:.75rem;}
.combo-item-meta{font-size:.8rem;color:var(--ap-muted);display:flex;flex-wrap:wrap;gap:.4rem;}
.combo-summary-box{border:1px solid rgba(13,148,136,.35);background:rgba(13,148,136,.08);border-radius:12px;padding:.9rem 1rem;display:flex;flex-direction:column;gap:.35rem;}
.combo-badge{background:rgba(13,148,136,.12);color:#0f766e;border-radius:999px;padding:.2rem .6rem;font-size:.75rem;font-weight:500;}
.combo-actions{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem;}
.combo-saved-list{display:flex;flex-direction:column;gap:.6rem;}
.combo-saved-card{border:1px solid var(--ap-border);border-radius:12px;padding:.8rem 1rem;background:#fff;display:flex;justify-content:space-between;gap:.75rem;align-items:flex-start;}
.combo-saved-card:hover{border-color:#0d9488;box-shadow:0 4px 16px rgba(13,148,136,.18);}
.combo-empty{padding:1rem;border:1px dashed var(--ap-border);border-radius:12px;background:var(--ap-bg-soft);color:var(--ap-muted);}
.combo-pill{border:1px solid rgba(15,23,42,.12);border-radius:999px;padding:.15rem .5rem;font-size:.75rem;background:#fff;color:#0f172a;}
.combo-suggest{position:relative;}
.combo-suggest-list{position:absolute;top:100%;left:0;right:0;margin-top:.3rem;background:#fff;border:1px solid var(--ap-border);border-radius:12px;box-shadow:0 12px 30px rgba(15,23,42,.18);max-height:260px;overflow:auto;z-index:1070;}
.combo-suggest-item{padding:.45rem .75rem;display:flex;flex-direction:column;gap:.1rem;cursor:pointer;}
.combo-suggest-item strong{font-size:.9rem;}
.combo-suggest-item small{font-size:.75rem;color:var(--ap-muted);}
.combo-suggest-item:hover,.combo-suggest-item.active{background:rgba(13,148,136,.12);}
</style>
{% endblock %}

{% block content %}

{# ================= Toolbar ================= #}
<div class="card mb-3">
  <div class="card-toolbar">
    <div class="d-flex align-items-center gap-2">
      <i data-lucide="search-code"></i>
      <div>
        <div class="section-title">Consulta &amp; Comparar</div>
        <div class="soft">Pesquise, compare colunas e detalhe por versões ou prestadores.</div>
      </div>
    </div>
    <div class="d-none d-md-block"><span class="pill">• Ferramentas de Tabelas</span></div>
  </div>

  {# ================= Filtros ================= #}
  <div class="p-3 filters">
    <form id="consultaForm" method="get" action="{{ url_for('consulta_comparar') }}" class="row g-3 align-items-end needs-validation" novalidate>
      <input type="hidden" name="run" value="1">

      <div class="col-12 col-lg-4">
        <label class="form-label">Tabela (nome)</label>
        <select class="form-select" name="tabela_nome" required>
          <option value="" disabled {% if not tabela_nome %}selected{% endif %}>Selecione...</option>
          {% for n in nomes %}
            <option value="{{ n }}" {% if tabela_nome==n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
        <div class="invalid-feedback">Selecione uma tabela para continuar.</div>
      </div>

      <div class="col-6 col-lg-2">
        <label class="form-label">UF</label>
        <select class="form-select" name="uf">
          <option value="" {% if not selected_uf %}selected{% endif %}>Todas</option>
          {% for uf in UFS %}<option value="{{ uf }}" {% if selected_uf==uf %}selected{% endif %}>{{ uf }}</option>{% endfor %}
        </select>
      </div>

      <div class="col-12 col-lg-6">
  <label class="form-label d-flex justify-content-between align-items-center gap-2">
    <span>Procedimentos (múltiplos)</span>
    <span class="mini-label" id="cbhpmProcCounter" aria-live="polite"></span>
  </label>

  <!-- Picker de procedimentos (CBHPM) -->
  <div id="cbhpmProcPicker" class="ap-picker" role="combobox" aria-haspopup="listbox" aria-expanded="false">
    <div class="ap-chips" id="cbhpmChips" aria-live="polite"></div>
    <input id="cbhpmInput" type="text" class="form-control ap-input"
           autocomplete="off" placeholder="Digite código ou parte da descrição...">
    <div id="cbhpmList" class="ap-list" role="listbox" hidden></div>
  </div>

  <div id="cbhpmVersoesHint" class="ap-hint mt-2" hidden>
    <span class="mini-label">CBHPM sugeridas para marcar</span>
    <div class="soft mb-2">As versões destacadas abaixo têm o procedimento digitado. Marque-as na lista de versões se quiser compará-las.</div>
    <div class="d-flex flex-wrap gap-2" id="cbhpmVersoesHintList"></div>
  </div>

  <div class="mt-1 soft">
    Dica: use “<span class="kbd">código - descrição</span>”. Pressione
    <span class="kbd">Enter</span> para adicionar. Você também pode usar o campo
    “Pacote” abaixo (1 código por linha).
  </div>
</div>



      <div class="col-12 col-lg-2 d-grid">
        <button id="btnSubmitComparar" class="btn btn-primary btn-icon" type="submit" data-default-label="Comparar">
          <span class="spinner-border spinner-border-sm" aria-hidden="true" hidden></span>
          <span class="btn-icon-slot" data-state="icon"><i data-lucide="equal"></i></span>
          <span class="btn-icon-slot" data-state="label">Comparar</span>
        </button>
      </div>

      <div class="col-12 col-lg-2 d-grid">
        <button type="button" class="btn btn-outline-secondary btn-icon" id="btnResetFiltros">
          <i data-lucide="rotate-ccw"></i> Limpar filtros
        </button>
      </div>

      {% if is_cbhpm %}
        <div class="col-12">
          <div class="alert alert-info py-2 mb-2 d-flex align-items-center gap-2">
            <i data-lucide="info"></i>
            <div>CBHPM detectado para a tabela selecionada. Marque as <strong>versões</strong> para comparar.</div>
          </div>
        </div>
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
            <div class="soft">Versões disponíveis <span class="mini-label" id="versoesCount" aria-live="polite"></span></div>
            <div class="d-flex flex-wrap gap-2">
              <div class="input-group input-group-sm" style="width:220px;">
                <span class="input-group-text"><i data-lucide="search"></i></span>
                <input type="search" class="form-control" id="filtroVersoes" placeholder="Filtrar versões..." aria-label="Filtrar versões">
              </div>
              <button id="btnMarkAllVersoes" type="button" class="btn btn-sm btn-outline-secondary btn-icon"><i data-lucide="check-square"></i> Marcar todas</button>
              <button id="btnClearVersoes" type="button" class="btn btn-sm btn-outline-secondary btn-icon"><i data-lucide="eraser"></i> Limpar</button>
            </div>
          </div>
          <div class="row g-2 check-grid" id="versoesChecklist">
            {% for v in versoes_disp %}
            <div class="col-12 col-sm-6 col-md-4 col-lg-3">
              <div class="form-check">
                <input class="form-check-input ver-chk" type="checkbox" name="versoes" id="ver{{ loop.index }}" value="{{ v }}" {% if v in (selected_versoes or []) %}checked{% endif %}>
                <label class="form-check-label" for="ver{{ loop.index }}">{{ v }}</label>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        {% if prestadores_disp %}
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
            <div class="soft">Prestadores <span class="mini-label" id="prestadoresCount" aria-live="polite"></span></div>
            <div class="d-flex flex-wrap gap-2">
              <div class="input-group input-group-sm" style="width:220px;">
                <span class="input-group-text"><i data-lucide="search"></i></span>
                <input type="search" class="form-control" id="filtroPrestadores" placeholder="Filtrar prestadores..." aria-label="Filtrar prestadores">
              </div>
            </div>
          </div>
          <div class="row g-2 check-grid" id="prestadoresChecklist">
            {% for p in prestadores_disp %}
            <div class="col-12 col-sm-6 col-md-4 col-lg-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="prestadores" id="pr{{ loop.index }}" value="{{ p }}" {% if p in (selected_prestadores or []) %}checked{% endif %}>
                <label class="form-check-label" for="pr{{ loop.index }}">{{ p }}</label>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      {% endif %}
    </form>
  </div>
</div>

{# ================= Resultados ================= #}
{% if show_results %}
  {% set all_cols = columns or [] %}
  {% set display_cols = (all_cols[:3] if is_cbhpm else all_cols) %}
  {% set display_len = display_cols|length %}

  <div class="card p-2 mb-3">
    <div class="d-flex align-items-center justify-content-between px-2">
      <div class="meta">
        <span class="section-title">Resultados</span>
        <span class="chip">Tabela: <strong class="ms-1">{{ tabela_nome or '-' }}</strong></span>
        {% if selected_uf %}<span class="chip">UF: <strong class="ms-1">{{ selected_uf }}</strong></span>{% endif %}
        {% if is_cbhpm %}
          <span class="chip">Mostrando {{ display_len }} de {{ (columns|length) if columns else 0 }} versões</span>
        {% else %}
          <span class="chip">Colunas exibidas: {{ display_len }}</span>
        {% endif %}
      </div>
      <div class="d-flex gap-2">
        <button id="btnCopyResults"  type="button" class="btn btn-sm btn-outline-secondary btn-icon"><i data-lucide="clipboard-copy"></i> Copiar</button>
        <button id="btnExportCSV"   type="button" class="btn btn-sm btn-outline-secondary btn-icon"><i data-lucide="download"></i> Exportar CSV</button>
        <button id="btnRadarOportunidades" type="button" class="btn btn-sm btn-outline-success btn-icon">
          <i data-lucide="radar"></i> Radar de oportunidades
        </button>
      </div>
    </div>

    <div class="table-responsive mt-2" style="max-height:70vh">
      <table class="table table-sm table-hover table-smart table-sticky-first align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:130px;">Código</th>
            <th>Descrição</th>
            {% if show_tuss_rol %}
            <th class="text-center">ROL ANS</th>
            {% endif %}
            {% for c in display_cols %}<th class="text-end">{{ c }}</th>{% endfor %}
            <th class="text-end">Mín</th>
            <th class="text-end">Média</th>
            <th class="text-end">Máx</th>
            {% if is_cbhpm %}<th class="text-center" title="Detalhar"><i data-lucide="list-ordered"></i></th>{% else %}<th class="text-end">N</th>{% endif %}
          </tr>
        </thead>
        <tbody id="results-body">
          {% for r in (rows or []) %}
            {% set vals = (r['values'] if r and (r['values'] is defined) else []) %}
            <tr>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <a href="#" class="js-open-detalhe" data-codigo="{{ r['codigo'] }}">{{ r['codigo'] }}</a>
                  <button type="button" class="btn btn-sm btn-outline-success btn-icon js-add-combo" data-codigo="{{ r['codigo'] }}" data-descricao="{{ r['descricao']|e }}" title="Adicionar ao combo">
                    <i data-lucide="plus"></i>
                  </button>
                </div>
              </td>
              <td>{{ r['descricao'] }}</td>
              {% if show_tuss_rol %}
                {% set rol = r.get('rol') %}
                <td class="text-center">
                  {% if rol %}
                    {% if rol.consta %}
                      <span class="badge text-bg-success" {% if rol.descricao %}title="{{ rol.descricao }}"{% endif %}>Sim</span>
                    {% else %}
                      <span class="badge text-bg-secondary" {% if rol.descricao %}title="{{ rol.descricao }}"{% endif %}>Não</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              {% endif %}
              {% for i in range(display_len) %}
                {% set v = (vals[i] if i < (vals|length) else None) %}
                <td class="text-end">{{ v|brl if v is not none else '-' }}</td>
              {% endfor %}
              <td class="text-end fw-semibold">{{ r['min']|brl if r['min'] is not none else '-' }}</td>
              <td class="text-end">{{ r['avg']|brl if r['avg'] is not none else '-' }}</td>
              <td class="text-end fw-semibold">{{ r['max']|brl if r['max'] is not none else '-' }}</td>
              {% if is_cbhpm %}
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-primary js-open-detalhe" data-codigo="{{ r['codigo'] }}" title="Ver todas as versões">
                    <i data-lucide="list-ordered"></i>
                  </button>
                </td>
              {% else %}
                <td class="text-end">{{ r['count'] }}</td>
              {% endif %}
            </tr>
          {% endfor %}
          {% if not rows %}
            <tr>
              {% set total_cols = 6 + display_len + (1 if show_tuss_rol else 0) %}
              <td colspan="{{ total_cols }}">
                <div class="empty"><i data-lucide="search-x"></i> Sem resultados para os filtros atuais.</div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

{# ================= Simulador ================= #}
<div class="card p-3">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <div class="section-title">Simulador</div>
      <div class="soft">CBHPM e Diárias/Taxas/Pacotes</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button type="button" class="btn btn-outline-success btn-sm btn-icon" id="btnOpenComboModal">
        <i data-lucide="puzzle"></i> Combos de procedimento
      </button>
      <ul class="nav nav-pills">
        <li class="nav-item">
          <button class="nav-link active btn-icon" data-bs-toggle="pill" data-bs-target="#tab-cbhpm" type="button">
            <i data-lucide="stethoscope"></i> CBHPM
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link btn-icon" data-bs-toggle="pill" data-bs-target="#tab-dtp" type="button">
            <i data-lucide="folder-cog"></i> Diárias/Taxas/Pacotes
          </button>
        </li>
      </ul>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 align-items-center mt-2" id="cbhpmScenarioControls">
    <button type="button" class="btn btn-outline-secondary btn-icon btn-sm" id="btnSaveScenario">
      <i data-lucide="bookmark-plus"></i> Salvar cenário
    </button>
    <div class="input-group input-group-sm" style="max-width:360px;">
      <span class="input-group-text"><i data-lucide="archive"></i></span>
      <select class="form-select" id="cbhpmSavedList">
        <option value="">Cenários salvos...</option>
      </select>
      <button class="btn btn-outline-primary" type="button" id="btnApplyScenario">Aplicar</button>
      <button class="btn btn-outline-danger" type="button" id="btnDeleteScenario">Excluir</button>
    </div>
  </div>

  <div class="tab-content mt-3">
    {# ==== CBHPM ==== #}
    <div class="tab-pane fade show active" id="tab-cbhpm">
      <form id="form-cbhpm" class="row g-3" autocomplete="off">
        <div class="col-12 col-lg-6">
          <label class="form-label">Código (ou "código - descrição")</label>
          <input class="form-control" id="cbhpm-codigo" placeholder="Ex: 12345 ou 12345 - texto">
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">UF</label>
          <select class="form-select" id="cbhpm-uf">
            <option value="">(opcional)</option>
            {% for uf in UFS %}<option value="{{ uf }}">{{ uf }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-6 col-lg-4">
          <label class="form-label">Versão (nome da tabela CBHPM)</label>
          <select class="form-select" id="cbhpm-versao">
            <option value="">Automática</option>
            {% for v in cbhpm_list_all %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
          </select>
        </div>

        <div class="col-6 col-lg-3">
          <label class="form-label">Tabela de Porte (hint)</label>
          <select class="form-select" id="cbhpm-porte">
            <option value="">Automático</option>
            {% for p in porte_list %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-6 col-lg-3">
          <label class="form-label">Tabela Porte AN (hint)</label>
          <select class="form-select" id="cbhpm-porte-an">
            <option value="">Automático</option>
            {% for p in porte_an_list %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">Ajuste Porte %</label>
          <input class="form-control" id="cbhpm-aj-porte" type="number" step="0.01" value="0">
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">Ajuste Porte AN %</label>
          <input class="form-control" id="cbhpm-aj-an" type="number" step="0.01" value="0">
        </div>
        <div class="col-6 col-lg-1">
          <label class="form-label">UCO (R$)</label>
          <input class="form-control" id="cbhpm-uco" placeholder="ex: 0,55">
        </div>
        <div class="col-6 col-lg-1">
          <label class="form-label">Filme (R$)</label>
          <input class="form-control" id="cbhpm-filme" placeholder="ex: 10,00">
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">Incidências</label>
          <input class="form-control" id="cbhpm-incid" placeholder="ex: 2">
        </div>

        <div class="col-12">
          <label class="form-label">Pacote (múltiplos códigos, 1 por linha)</label>
          <textarea class="form-control" id="cbhpm-pacote" rows="2" placeholder="30101012&#10;30101013"></textarea>
          <div class="mt-2 border rounded-3 bg-light p-3" id="cbhpm-dtp-helper">
            <div class="d-flex flex-wrap gap-2 align-items-end">
              <div class="flex-grow-1">
                <label class="mini-label" for="cbhpm-dtp-tabela">Tabela DTP (Diarias/Taxas/Pacotes)</label>
                <select class="form-select form-select-sm" id="cbhpm-dtp-tabela">
                  <option value="">Selecione...</option>
                  {% for n in dtp_list %}<option value="{{ n }}">{{ n }}</option>{% endfor %}
                </select>
              </div>
              <div style="min-width:120px">
                <label class="mini-label" for="cbhpm-dtp-uf">UF</label>
                <select class="form-select form-select-sm" id="cbhpm-dtp-uf">
                  <option value="">(todas)</option>
                  {% for uf in UFS %}<option value="{{ uf }}">{{ uf }}</option>{% endfor %}
                </select>
              </div>
              <div class="flex-grow-1">
                <label class="mini-label" for="cbhpm-dtp-q">Buscar termo</label>
                <input class="form-control form-control-sm" id="cbhpm-dtp-q" placeholder="Ex.: diaria, 3010">
              </div>
              <div>
                <button type="button" class="btn btn-sm btn-outline-primary btn-icon" id="btnCbhpmDtpBuscar"><i data-lucide="search"></i> Buscar DTP</button>
              </div>
            </div>
            <div class="mt-3" id="cbhpm-dtp-results" style="max-height:230px; overflow:auto;"></div>
            <div class="mt-2" id="cbhpm-dtp-selected" hidden>
              <div class="mini-label mb-1">Itens DTP adicionados</div>
              <div class="d-flex flex-wrap gap-2" id="cbhpm-dtp-selected-list"></div>
            </div>
          </div>
        </div>

        <div class="col-12 d-flex gap-2">
  <button class="btn btn-primary btn-icon" type="button" id="btnSimularCBHPM">
    <i class="bi bi-calculator"></i> Simular
  </button>

  <!-- NOVOS -->
  <button class="btn btn-outline-success btn-icon" type="button" id="btnExportCBHPMXLSX">
    <i class="bi bi-file-earmark-excel"></i> Exportar XLSX
  </button>
  <button class="btn btn-outline-danger btn-icon" type="button" id="btnExportCBHPMPDF">
    <i class="bi bi-filetype-pdf"></i> Exportar PDF
  </button>
  <!-- /NOVOS -->

  <button class="btn btn-outline-secondary btn-icon" type="reset">
    <i class="bi bi-arrow-counterclockwise"></i> Limpar
  </button>
</div>

      </form>

      <div id="cbhpm-out" class="mt-3"></div>
    </div>

    {# ==== DTP ==== #}
    <div class="tab-pane fade" id="tab-dtp">
      <form id="form-dtp" class="row g-3" autocomplete="off">
        <div class="col-12 col-lg-5">
          <label class="form-label">Tabela DTP (Diárias/Taxas/Pacotes)</label>
          <select class="form-select" id="dtp-tabela">
            <option value="">Selecione...</option>
            {% for n in dtp_list %}<option value="{{ n }}">{{ n }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">UF</label>
          <select class="form-select" id="dtp-uf">
            <option value="">(opcional)</option>
            {% for uf in UFS %}<option value="{{ uf }}">{{ uf }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-12 col-lg-5">
          <label class="form-label">Termo (código ou parte da descrição)</label>
          <input class="form-control" id="dtp-q" placeholder="Ex.: 3010 ou diária enfermaria">
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary btn-icon" type="button" id="btnBuscarDTP"><i data-lucide="search"></i> Buscar</button>
          <button class="btn btn-outline-secondary btn-icon" type="reset"><i data-lucide="rotate-ccw"></i> Limpar</button>
        </div>
      </form>

      <div id="dtp-out" class="mt-3"></div>
    </div>
  </div>
</div>

{# ================= Radar de Oportunidades ================= #}
<div class="modal fade" id="radarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Radar de oportunidades</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
          <div class="soft small">Itens com maior potencial de negociação considerando amplitude de preços, média vs. teto e variações por combo.</div>
          <div class="ms-auto d-flex gap-2 flex-wrap">
            <div class="input-group input-group-sm" style="max-width:260px;">
              <span class="input-group-text"><i data-lucide="search"></i></span>
              <input type="search" class="form-control" id="radarSearch" placeholder="Filtrar por código ou descrição">
            </div>
            <select class="form-select form-select-sm" id="radarOrdenacao" style="max-width:220px;">
              <option value="amplitude_desc">Maior amplitude de preço</option>
              <option value="media_desc">Média mais alta</option>
              <option value="potencial_neg_desc">Economia potencial</option>
            </select>
          </div>
        </div>
        <div id="radarResumo" class="combo-summary-box mb-3" hidden></div>
        <div id="radarLista" class="d-flex flex-column gap-3"></div>
      </div>
      <div class="modal-footer">
        <div class="soft small me-auto">Dica: clique em “explorar” para empurrar o item diretamente para filtros/simulador.</div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

{# ================= Modal Combos ================= #}
<div class="modal fade" id="comboModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Montar combos de procedimento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="combo-card" id="comboProcedimentoCard">
          <div class="combo-card-header">
            <div>
              <h5 class="mb-1">Combo ativo</h5>
              <div class="soft small">Monte pacotes rápidos, compare totais e salve combinações recorrentes para o simulador.</div>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <span class="combo-pill" id="comboActiveStats">0 itens • Total —</span>
              <button type="button" class="btn btn-outline-primary btn-sm btn-icon" id="comboImportFromClipboard">
                <i data-lucide="clipboard-plus"></i> Colar itens
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm btn-icon" id="comboToggleTips" aria-expanded="false">
                <i data-lucide="sparkles"></i> Inspirações
              </button>
            </div>
          </div>
          <div class="combo-card-body">
            <div class="combo-builder">
              <div>
                <div class="combo-ghost">
                  <div class="d-flex justify-content-between align-items-start gap-2">
                    <div>
                      <div class="fw-semibold">Combo ativo</div>
                      <div class="soft small">Nomeie o combo e adicione itens com código, descrição, quantidade e valor de referência.</div>
                    </div>
                    <div class="d-flex flex-column gap-2 align-items-end">
                      <input type="text" class="form-control form-control-sm" id="comboName" placeholder="Nome do combo (ex.: Hemograma completo)" style="min-width:220px;">
                      <div class="form-text text-end small">Salve para reutilizar em futuras comparações.</div>
                    </div>
                  </div>

                  <form class="row g-2 mt-3" id="comboItemForm" autocomplete="off">
                    <div class="col-12 col-md-3">
                      <label class="form-label small text-muted mb-1">Código</label>
                      <div class="combo-suggest">
                        <input type="text" class="form-control form-control-sm" id="comboItemCodigo" placeholder="Ex.: 30101018">
                        <div class="combo-suggest-list" id="comboCodeSuggestions" hidden></div>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <label class="form-label small text-muted mb-1">Descrição</label>
                      <input type="text" class="form-control form-control-sm" id="comboItemDescricao" placeholder="Visita hospitalar">
                    </div>
                    <div class="col-6 col-md-2">
                      <label class="form-label small text-muted mb-1">Quantidade</label>
                      <input type="number" min="1" step="1" class="form-control form-control-sm" id="comboItemQuantidade" value="1">
                    </div>
                    <div class="col-6 col-md-2">
                      <label class="form-label small text-muted mb-1">Valor ref. (R$)</label>
                      <input type="text" class="form-control form-control-sm" id="comboItemValor" placeholder="120,00">
                    </div>
                    <div class="col-12 col-md-1 d-grid">
                      <label class="form-label small text-muted mb-1">&nbsp;</label>
                      <button type="submit" class="btn btn-sm btn-primary btn-icon" id="comboItemAdd">
                        <i data-lucide="plus-circle"></i> Add
                      </button>
                    </div>
                  </form>

                  <div class="combo-actions">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="comboClearItems">
                      <i data-lucide="trash-2"></i> Limpar combo
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="comboSave">
                      <i data-lucide="bookmark-plus"></i> Salvar combo
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" id="comboApplyToFilters">
                      <i data-lucide="sliders-horizontal"></i> Aplicar nos filtros
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="comboCopyResumo">
                      <i data-lucide="clipboard-list"></i> Copiar resumo
                    </button>
                  </div>

                  <div class="combo-items-list" id="comboItemsList">
                    <div class="combo-empty">Ainda sem itens. Adicione um procedimento para começar o combo.</div>
                  </div>

                  <div class="combo-summary-box mt-3" id="comboSummaryBox" hidden>
                    <div class="d-flex justify-content-between">
                      <span>Total estimado</span>
                      <strong id="comboSummaryTotal">R$ 0,00</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span>Média por item</span>
                      <span id="comboSummaryMedia">—</span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span>Quantidade total</span>
                      <span id="comboSummaryQuantidade">—</span>
                    </div>
                  </div>
                </div>

                <div class="alert alert-info mt-3 d-none" id="comboTips">
                  <div class="d-flex gap-2 align-items-start">
                    <i data-lucide="wand-2"></i>
                    <div class="small">
                      <strong>Inspirações de combo</strong>
                      <ul class="mb-0 mt-2 ps-3">
                        <li>Pacote diagnóstico: hemograma + raio-x + consulta follow-up.</li>
                        <li>Acompanhamento crônico: consulta + telemonitoramento + exames trimestrais.</li>
                        <li>Internação curta: diária enfermaria + honorário + medicação base.</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <div class="h-100 combo-ghost">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                      <div class="fw-semibold">Favoritos &amp; histórico</div>
                      <div class="soft small">Carregue combos prontos, duplique ou remova os que não usa mais.</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" id="comboClearSaved">
                      <i data-lucide="trash"></i> Limpar todos
                    </button>
                  </div>
                  <div class="combo-saved-list" id="comboSavedList">
                    <div class="combo-empty">Sem combos salvos no momento.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

{# ================= Modal de detalhe ================= #}
<div class="modal fade" id="detalheModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% if is_cbhpm %}Detalhe por versões — CBHPM{% else %}Detalhe por prestador{% endif %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><div class="text-center text-muted py-4">Selecione um item...</div></div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>

'use strict';
const restoreCbhpmPayload = {{ restore_cbhpm_payload|tojson|default('null') }};
const PROCEDIMENTO_SUGGEST_URL = '/api/procedimentos/suggest';
const VERSOES_POR_CODIGO_URL = {{ url_for('api_versoes_por_codigo')|tojson }};
const cbhpmDtpSearchCache = new Map();
const cbhpmDtpMeta = new Map();
const HAS_TUSS_ROL = {{ show_tuss_rol|tojson }};
{% if show_tuss_rol %}
const tussRolCache = new Map();

function fetchRolStatus(codigo){
  const key = (codigo || '').trim().toUpperCase();
  if(!key) return Promise.resolve(null);
  if(tussRolCache.has(key)) return Promise.resolve(tussRolCache.get(key));
  return fetch(`/api/tuss-rol/${encodeURIComponent(key)}`)
    .then(res=>{
      if(res.status === 404){
        tussRolCache.set(key, null);
        return null;
      }
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    })
    .then(data=>{
      if(!data) return null;
      const payload = { consta: !!data.consta, descricao: data.descricao || '' };
      tussRolCache.set(key, payload);
      return payload;
    })
    .catch(()=>null);
}

function renderRolStatus(slotEl, codigo){
  if(!slotEl) return;
  slotEl.innerHTML = '<div class="soft text-muted">Consultando presença no ROL...</div>';
  fetchRolStatus(codigo).then(info=>{
    if(!slotEl.isConnected) return;
    slotEl.innerHTML = '';
    if(!info){
      const msg = document.createElement('div');
      msg.className = 'soft text-muted';
      msg.textContent = 'Sem correlação cadastrada no ROL.';
      slotEl.appendChild(msg);
      return;
    }
    const badge = document.createElement('span');
    badge.className = 'badge ' + (info.consta ? 'text-bg-success' : 'text-bg-secondary');
    badge.textContent = info.consta ? 'Sim' : 'Não';
    const label = document.createElement('span');
    label.className = 'ms-2 fw-semibold';
    label.textContent = info.consta ? 'Consta no ROL da ANS' : 'Fora do ROL da ANS';
    slotEl.append(badge, label);
    if(info.descricao){
      const desc = document.createElement('div');
      desc.className = 'text-muted small mt-1';
      desc.textContent = info.descricao;
      slotEl.appendChild(desc);
    }
  });
}
{% else %}
const tussRolCache = null;
function fetchRolStatus(){ return Promise.resolve(null); }
function renderRolStatus(slotEl){ if(slotEl) slotEl.remove(); }
{% endif %}

const renderDtpSelected = () => {
  const wrap = document.getElementById('cbhpm-dtp-selected');
  const list = document.getElementById('cbhpm-dtp-selected-list');
  if(!wrap || !list) return;
  const entries = [...cbhpmDtpMeta.values()];
  if(!entries.length){
    wrap.hidden = true;
    list.innerHTML = '';
    return;
  }
  wrap.hidden = false;
  const html = entries.map(meta => {
    const code = meta.codigo || '';
    const desc = meta.descricao ? meta.descricao : '';
    const valor = meta.valor != null ? brl(meta.valor) : '-';
    const tabela = meta.tabela_nome ? ` <span class="text-muted">(${meta.tabela_nome})</span>` : '';
    return `<span class="badge bg-info-subtle text-info border d-flex align-items-center gap-2">`
         + `<span>${code}</span>`
         + `<span class="text-muted">${desc}${tabela}</span>`
         + `<span class="fw-semibold">${valor}</span>`
         + `<button type="button" class="btn btn-link btn-sm p-0 text-info-emphasis js-remove-dtp" data-code="${code}" aria-label="Remover">&times;</button>`
         + `</span>`;
  }).join('');
  list.innerHTML = html;
};

window._procedimentosSelecionados = {{ (procedimentos_raw or [])|tojson }};

/* ===== Util ===== */
const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));
const brl = (v)=>{ if(v===null||v===undefined||v==='')return '-'; const n=Number(v); return Number.isNaN(n)?v:n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); };
const pct = (v)=>{
  if(v===null||v===undefined||v==='') return null;
  const n = Number(v);
  if(Number.isNaN(n)) return null;
  return n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})+'%';
};
const esc = (value)=> String(value ?? '').replace(/[&<>"']/g, (ch)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
const toCSV = (rows)=>rows.map(r=>r.map(v=>{const s=(v??'').toString();return /[",;\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;}).join(';')).join('\n');
const download = (filename, text)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); };
const SCENARIO_STORAGE_KEY = 'cbhpmSavedScenarios.v1';

/* ===== Radar de oportunidades ===== */
const radarState = {
  raw: [],
  filtered: [],
  modal: null,
};

function toNumberSafe(value){
  if(value === null || value === undefined) return null;
  const n = Number(value);
  return Number.isFinite(n) ? n : null;
}

function collectRadarFromDom(){
  const body = document.getElementById('results-body');
  if(!body) return [];
  return Array.from(body.querySelectorAll('tr')).map(tr => {
    if(tr.querySelector('.empty')){
      return null;
    }
    const cells = Array.from(tr.cells);
    if(cells.length < 5){
      return null;
    }
    const codigo = cells[0]?.querySelector('a,button')?.textContent?.trim() || cells[0]?.textContent?.trim() || '';
    const descricao = cells[1]?.textContent?.trim() || '';
    const minIdx = cells.length - 4;
    const mediaIdx = cells.length - 3;
    const maxIdx = cells.length - 2;
    const minVal = parseCurrencyText(cells[minIdx]?.textContent);
    const mediaVal = parseCurrencyText(cells[mediaIdx]?.textContent);
    const maxVal = parseCurrencyText(cells[maxIdx]?.textContent);
    const valores = [];
    for(let i=2;i<minIdx;i++){
      const num = parseCurrencyText(cells[i]?.textContent);
      if(num !== null){
        valores.push(num);
      }
    }
    const origem = cells[0]?.querySelector('.badge')?.textContent?.trim() || '';
    const countIdx = cells.length - 1;
    const count = parseInt((cells[countIdx]?.textContent || '').replace(/\D+/g,''), 10);
    return {
      codigo,
      descricao,
      origem,
      min: minVal,
      max: maxVal,
      avg: mediaVal,
      values: valores,
      count: Number.isFinite(count) ? count : null,
    };
  }).filter(Boolean);
}

function parseCurrencyText(text){
  if(!text) return null;
  const cleaned = text.replace(/[^\d,-]/g,'').replace(/\./g,'').replace(',', '.').trim();
  if(!cleaned) return null;
  const num = Number(cleaned);
  return Number.isFinite(num) ? num : null;
}

function prepareRadarItems(source){
  return (Array.isArray(source) ? source : []).map(row => {
    const codigo = row?.codigo || row?.tuss || '';
    const descricao = row?.descricao || '';
    const valores = Array.isArray(row?.values) ? row.values.map(toNumberSafe).filter(Number.isFinite) : [];
    const minVal = toNumberSafe(row?.min ?? (valores.length ? Math.min(...valores) : null));
    const maxVal = toNumberSafe(row?.max ?? (valores.length ? Math.max(...valores) : null));
    const mediaVal = toNumberSafe(row?.avg ?? (valores.length ? (valores.reduce((acc, cur)=>acc+cur,0)/valores.length) : null));
    if(!codigo){
      return null;
    }
    const amplitude = (maxVal !== null && minVal !== null) ? maxVal - minVal : null;
    const economyPotential = (mediaVal !== null && minVal !== null) ? mediaVal - minVal : null;
    const spreadPct = (mediaVal && amplitude !== null) ? (amplitude / mediaVal) * 100 : null;
    return {
      codigo,
      descricao,
      origem: row?.origem || '',
      valores,
      min: minVal,
      max: maxVal,
      media: mediaVal,
      amplitude,
      spreadPct,
      economyPotential,
      count: row?.count || (row?.values ? row.values.length : null),
    };
  }).filter(Boolean);
}

function describeOpportunity(item){
  if(item.amplitude !== null && item.amplitude > 0 && item.economyPotential !== null){
    if(item.amplitude > (item.media || 0)){
      return 'Dispersão alta: renegociar ou padronizar fornecedores.';
    }
    if(item.economyPotential > 0){
      return 'Há margem para trazer o preço médio para o piso do mercado.';
    }
  }
  return 'Combine com similares e histórico para definir estratégia.';
}

function renderRadar(){
  const list = document.getElementById('radarLista');
  const resumo = document.getElementById('radarResumo');
  if(!list){
    return;
  }
  const items = radarState.filtered;
  if(!items.length){
    list.innerHTML = '<div class="combo-empty">Nenhum dado disponível para o radar. Execute uma busca ou ajuste os filtros.</div>';
    if(resumo){ resumo.hidden = true; }
    return;
  }
  const totalAmplitude = items.reduce((acc, item)=> acc + (item.amplitude || 0), 0);
  const totalOportunidade = items.reduce((acc, item)=> acc + Math.max(item.economyPotential || 0, 0), 0);
  if(resumo){
    resumo.hidden = false;
    resumo.innerHTML = `
      <div class="d-flex flex-wrap gap-3">
        <div><strong>${items.length}</strong> itens analisados</div>
        <div>Amplitude somada: ${brl(totalAmplitude)}</div>
        <div>Economia potencial (média → piso): ${brl(totalOportunidade)}</div>
      </div>
    `;
  }
  list.innerHTML = items.map(item => {
    const amplitudeBadge = item.amplitude !== null ? `<span class="badge bg-warning-subtle text-warning">Amplitude ${brl(item.amplitude)}</span>` : '';
    const potentialBadge = item.economyPotential !== null ? `<span class="badge bg-success-subtle text-success">Potencial ${brl(item.economyPotential)}</span>` : '';
    const spreadBadge = item.spreadPct !== null ? `<span class="badge bg-info-subtle text-info">Spread ${formatDiffPercent(item.spreadPct)}</span>` : '';
    return `
      <div class="border rounded-4 p-3 bg-white shadow-sm">
        <div class="d-flex justify-content-between gap-3 align-items-start">
          <div>
            <div class="fw-semibold">${esc(item.codigo)} · ${esc(item.descricao || '')}</div>
            <div class="text-muted small">Origem: ${esc(item.origem || '—')}</div>
            <div class="d-flex flex-wrap gap-1 mt-2">
              ${amplitudeBadge}
              ${potentialBadge}
              ${spreadBadge}
            </div>
          </div>
          <div class="text-end small">
            <div>Mín: ${item.min !== null ? brl(item.min) : '—'}</div>
            <div>Média: ${item.media !== null ? brl(item.media) : '—'}</div>
            <div>Máx: ${item.max !== null ? brl(item.max) : '—'}</div>
          </div>
        </div>
        <p class="small text-muted mt-3 mb-3">${esc(describeOpportunity(item))}</p>
        <div class="d-flex gap-2 flex-wrap">
          <button type="button" class="btn btn-sm btn-outline-primary js-radar-detalhe" data-codigo="${esc(item.codigo)}">
            <i data-lucide="eye"></i> Detalhar
          </button>
          <button type="button" class="btn btn-sm btn-outline-success js-radar-simulador" data-codigo="${esc(item.codigo)}">
            <i data-lucide="sliders"></i> Aplicar no simulador
          </button>
        </div>
      </div>
    `;
  }).join('');
  if(window.lucide){ lucide.createIcons(list); }
}

function applyRadarFilters(){
  const q = (document.getElementById('radarSearch')?.value || '').trim().toLowerCase();
  const sort = document.getElementById('radarOrdenacao')?.value || 'amplitude_desc';
  let items = radarState.raw.slice();
  if(q){
    items = items.filter(item => item.codigo.toLowerCase().includes(q) || (item.descricao || '').toLowerCase().includes(q));
  }
  items.sort((a, b)=>{
    switch(sort){
      case 'media_desc':
        return (b.media || 0) - (a.media || 0);
      case 'potencial_neg_desc':
        return (b.economyPotential || 0) - (a.economyPotential || 0);
      case 'amplitude_desc':
      default:
        return (b.amplitude || 0) - (a.amplitude || 0);
    }
  });
  radarState.filtered = items.slice(0, 20);
  renderRadar();
}

function showRadarModal(){
  if(!radarState.modal && window.bootstrap && bootstrap.Modal){
    const modalEl = document.getElementById('radarModal');
    if(modalEl){
      radarState.modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    }
  }
  applyRadarFilters();
  radarState.modal?.show();
}

function initRadar(){
  radarState.raw = prepareRadarItems(collectRadarFromDom());
  radarState.filtered = radarState.raw.slice();
  document.getElementById('radarSearch')?.addEventListener('input', applyRadarFilters);
  document.getElementById('radarOrdenacao')?.addEventListener('change', applyRadarFilters);
  const list = document.getElementById('radarLista');
  if(list){
    list.addEventListener('click', evt=>{
      const detalheBtn = evt.target.closest('.js-radar-detalhe');
      if(detalheBtn){
        const codigo = detalheBtn.getAttribute('data-codigo');
        if(codigo){
          showRadarModal(); // keep open
          if(typeof openDetalhe === 'function'){
            openDetalhe(codigo);
          }
        }
        return;
      }
      const aplicarBtn = evt.target.closest('.js-radar-simulador');
      if(aplicarBtn){
        const codigo = aplicarBtn.getAttribute('data-codigo');
        if(codigo){
          const input = document.getElementById('cbhpm-codigo');
          if(input){
            input.value = codigo;
            input.focus();
          }
          const pacote = document.getElementById('cbhpm-pacote');
          if(pacote && !pacote.value.includes(codigo)){
            pacote.value = `${codigo}\n${pacote.value}`.trim();
            pacote.dispatchEvent(new Event('input'));
          }
          if(window.showToast){
            showToast(`Código ${codigo} aplicado ao simulador.`, 'success');
          }
        }
        radarState.modal?.hide();
      }
    });
  }
  document.getElementById('btnRadarOportunidades')?.addEventListener('click', ()=>{
    showRadarModal();
  });
}

/* ===== Combos de procedimento ===== */
(function(){
  const STORAGE_KEY = 'consultaCompararCombos.v1';
  let comboActive = { id: null, name: '', items: [] };
  let comboSaved = [];

  const modalEl = document.getElementById('comboModal');
  const contextForm = document.getElementById('consultaForm');
  const card = document.getElementById('comboProcedimentoCard');
  if(!modalEl || !card) return;
  let comboModalInstance = null;

  function getModalInstance(){
    if(!window.bootstrap || !bootstrap.Modal) return null;
    if(comboModalInstance){
      return comboModalInstance;
    }
    comboModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    return comboModalInstance;
  }

  const refs = {
    nameInput: document.getElementById('comboName'),
    itemForm: document.getElementById('comboItemForm'),
    codigoInput: document.getElementById('comboItemCodigo'),
    codigoSuggest: document.getElementById('comboCodeSuggestions'),
    descricaoInput: document.getElementById('comboItemDescricao'),
    quantidadeInput: document.getElementById('comboItemQuantidade'),
    valorInput: document.getElementById('comboItemValor'),
    list: document.getElementById('comboItemsList'),
    summaryBox: document.getElementById('comboSummaryBox'),
    summaryTotal: document.getElementById('comboSummaryTotal'),
    summaryMedia: document.getElementById('comboSummaryMedia'),
    summaryQtd: document.getElementById('comboSummaryQuantidade'),
    statsPill: document.getElementById('comboActiveStats'),
    saveBtn: document.getElementById('comboSave'),
    clearBtn: document.getElementById('comboClearItems'),
    copyBtn: document.getElementById('comboCopyResumo'),
    applyBtn: document.getElementById('comboApplyToFilters'),
    importBtn: document.getElementById('comboImportFromClipboard'),
    tipsBtn: document.getElementById('comboToggleTips'),
    tipsBox: document.getElementById('comboTips'),
    savedList: document.getElementById('comboSavedList'),
    clearSavedBtn: document.getElementById('comboClearSaved'),
  };

  const comboSuggestState = {
    results: [],
    active: -1,
    controller: null,
    timer: null,
  };

  function comboContext(){
    const tabela = contextForm?.querySelector('[name="tabela_nome"]')?.value || '';
    const uf = contextForm?.querySelector('[name="uf"]')?.value || '';
    return { tabela, uf };
  }

  function clearSuggestions(){
    comboSuggestState.results = [];
    comboSuggestState.active = -1;
    clearTimeout(comboSuggestState.timer);
    comboSuggestState.timer = null;
    if(comboSuggestState.controller){
      comboSuggestState.controller.abort();
      comboSuggestState.controller = null;
    }
    if(refs.codigoSuggest){
      refs.codigoSuggest.innerHTML = '';
      refs.codigoSuggest.hidden = true;
    }
  }

  function renderSuggestions(){
    const listEl = refs.codigoSuggest;
    if(!listEl) return;
    if(!comboSuggestState.results.length){
      listEl.innerHTML = '';
      listEl.hidden = true;
      return;
    }
    listEl.innerHTML = comboSuggestState.results.map((item, idx)=>`
      <div class="combo-suggest-item ${idx===comboSuggestState.active?'active':''}" data-index="${idx}">
        <strong>${esc(item.codigo || '')}</strong>
        <small>${esc(item.descricao || '')}</small>
        ${item.extra ? `<small>${esc(item.extra)}</small>` : ''}
      </div>
    `).join('');
    listEl.hidden = false;
  }

  async function fetchSuggestions(query){
    const q = (query || '').trim();
    if(q.length < 2){
      clearSuggestions();
      return;
    }
    if(comboSuggestState.controller){
      comboSuggestState.controller.abort();
    }
    const controller = new AbortController();
    comboSuggestState.controller = controller;
    const params = new URLSearchParams({ q, limit: '25' });
    const ctx = comboContext();
    if(ctx.tabela) params.set('tabela_nome', ctx.tabela);
    if(ctx.uf) params.set('uf', ctx.uf);

    try{
      const resp = await fetch(`${PROCEDIMENTO_SUGGEST_URL}?${params.toString()}`, { signal: controller.signal });
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      const items = Array.isArray(data?.items) ? data.items : [];
      comboSuggestState.results = items.map(item => ({
        codigo: item.codigo ?? item.id ?? '',
        descricao: item.descricao ?? item.nome ?? '',
        extra: item.grupo ?? item.caminho ?? '',
        valor: item.valor ?? null,
      })).filter(item => item.codigo);
      comboSuggestState.active = comboSuggestState.results.length ? 0 : -1;
      renderSuggestions();
      comboSuggestState.controller = null;
    }catch(err){
      if(err?.name === 'AbortError') return;
      console.warn('combo suggest fail:', err);
      clearSuggestions();
    }
  }

  function scheduleSuggestions(query){
    clearTimeout(comboSuggestState.timer);
    comboSuggestState.timer = setTimeout(()=> fetchSuggestions(query), 200);
  }

  function applySuggestion(item){
    if(!item) return;
    if(refs.codigoInput) refs.codigoInput.value = item.codigo || '';
    if(refs.descricaoInput){
      const current = (refs.descricaoInput.value || '').trim();
      if(!current){
        refs.descricaoInput.value = item.descricao || '';
      }
    }
    if(refs.valorInput && item.valor != null){
      const num = Number(item.valor);
      if(Number.isFinite(num)){
        const formatted = num.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
        refs.valorInput.value = formatted;
      }
    }
    clearSuggestions();
    refs.descricaoInput?.focus();
  }

  function generateId(){
    return 'c' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
  }

  function parseCurrencyInput(value){
    if(value === null || value === undefined) return null;
    const raw = String(value).trim();
    if(!raw) return null;
    const normalized = raw.replace(/\s+/g, '').replace(/\./g, '').replace(',', '.');
    const num = Number(normalized);
    if(Number.isFinite(num)) return num;
    const fallback = Number(raw.replace(/[^\d,-]/g, '').replace(',', '.'));
    return Number.isFinite(fallback) ? fallback : null;
  }

  function formatDateTime(time){
    if(!time) return '';
    try{
      const date = new Date(time);
      if(Number.isNaN(date.getTime())) return '';
      return date.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    }catch(_err){
      return '';
    }
  }

  function normalizeItem(entry){
    if(!entry) entry = {};
    const codigo = typeof entry.codigo === 'string' ? entry.codigo.trim() : (entry.codigo != null ? String(entry.codigo).trim() : '');
    const descricao = typeof entry.descricao === 'string' ? entry.descricao.trim() : '';
    const quantidadeRaw = Number(entry.quantidade);
    const quantidade = Number.isFinite(quantidadeRaw) && quantidadeRaw > 0 ? Math.round(quantidadeRaw) : 1;
    const valorParsed = parseCurrencyInput(entry.valor);
    const key = typeof entry.key === 'string' ? entry.key : generateId();
    const valor = valorParsed !== null && valorParsed >= 0 ? valorParsed : null;
    const total = valor !== null ? valor * quantidade : null;
    return { key, codigo, descricao, quantidade, valor, total };
  }

  function normalizeCombo(data){
    if(!data) data = {};
    const items = Array.isArray(data.items) ? data.items.map(normalizeItem) : [];
    return {
      id: typeof data.id === 'string' ? data.id : generateId(),
      name: typeof data.name === 'string' ? data.name : '',
      items,
      created_at: data.created_at || Date.now(),
      updated_at: data.updated_at || Date.now(),
    };
  }

  function loadStorage(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const parsed = JSON.parse(raw);
      const savedRaw = Array.isArray(parsed?.saved) ? parsed.saved : [];
      comboSaved = savedRaw.map(normalizeCombo);
      if(parsed?.last){
        const last = normalizeCombo(parsed.last);
        comboActive = { id: last.id, name: last.name, items: last.items };
      }
    }catch(err){
      console.warn('Falha ao carregar combos salvos:', err);
    }
  }

  function persistStorage(){
    try{
      const payload = {
        saved: comboSaved.map(combo => ({
          id: combo.id,
          name: combo.name,
          items: combo.items,
          created_at: combo.created_at,
          updated_at: combo.updated_at,
        })),
        last: {
          id: comboActive.id,
          name: comboActive.name,
          items: comboActive.items,
          updated_at: Date.now(),
        },
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }catch(err){
      console.warn('Não foi possível persistir combos:', err);
    }
  }

  function updateStats(){
    const totalQtd = comboActive.items.reduce((acc, item)=> acc + item.quantidade, 0);
    const totalVal = comboActive.items.reduce((acc, item)=> acc + (item.total ?? 0), 0);
    const pricedCount = comboActive.items.filter(item => item.total !== null).length;
    const totalText = pricedCount ? brl(totalVal) : '—';
    if(refs.statsPill){
      refs.statsPill.textContent = `${comboActive.items.length} itens • Total ${totalText}`;
    }
  }

  function renderItems(){
    if(!refs.list) return;
    if(!comboActive.items.length){
      refs.list.innerHTML = '<div class="combo-empty">Ainda sem itens. Adicione um procedimento para começar o combo.</div>';
      if(refs.summaryBox){
        refs.summaryBox.hidden = true;
      }
      updateStats();
      if(window.lucide) lucide.createIcons();
      return;
    }
    const html = comboActive.items.map(item=>{
      const valorText = item.valor !== null ? brl(item.valor) : '—';
      const totalText = item.total !== null ? brl(item.total) : '—';
      const metaParts = [];
      if(item.codigo){
        metaParts.push(`<span class="combo-pill">Código ${esc(item.codigo)}</span>`);
      }
      metaParts.push(`<span class="combo-pill">Qtd ${item.quantidade}</span>`);
      metaParts.push(`<span class="combo-pill">${item.valor !== null ? `Valor ${valorText}` : 'Sem valor'}</span>`);
      const subtotalRow = item.total !== null
        ? `<div class="small text-muted">Subtotal ${totalText}</div>`
        : '';
      return `
        <div class="combo-item" data-key="${esc(item.key)}">
          <div class="combo-item-heading">
            <div>
              <div class="fw-semibold">${esc(item.descricao || 'Procedimento sem descrição')}</div>
              <div class="combo-item-meta">${metaParts.join(' ')}</div>
            </div>
            <div class="btn-group btn-group-sm flex-shrink-0">
              <button type="button" class="btn btn-outline-secondary" data-action="edit" data-key="${esc(item.key)}"><i data-lucide="pencil"></i></button>
              <button type="button" class="btn btn-outline-danger" data-action="remove" data-key="${esc(item.key)}"><i data-lucide="trash-2"></i></button>
            </div>
          </div>
          ${subtotalRow}
        </div>
      `;
    }).join('');
    refs.list.innerHTML = html;
    updateStats();
    updateSummary();
    if(window.lucide) lucide.createIcons();
  }

  function updateSummary(){
    if(!refs.summaryBox) return;
    if(!comboActive.items.length){
      refs.summaryBox.hidden = true;
      return;
    }
    const totalQtd = comboActive.items.reduce((acc, item)=> acc + item.quantidade, 0);
    const pricedItems = comboActive.items.filter(item => item.total !== null);
    const totalVal = pricedItems.reduce((acc, item)=> acc + (item.total ?? 0), 0);
    const media = totalQtd > 0 && totalVal > 0 ? totalVal / totalQtd : null;
    refs.summaryBox.hidden = false;
    refs.summaryTotal.textContent = pricedItems.length ? brl(totalVal) : '—';
    refs.summaryMedia.textContent = media !== null ? brl(media) : '—';
    refs.summaryQtd.textContent = totalQtd;
  }

  function renderSaved(){
    if(!refs.savedList) return;
    if(!comboSaved.length){
      refs.savedList.innerHTML = '<div class="combo-empty">Sem combos salvos no momento.</div>';
      if(window.lucide) lucide.createIcons();
      return;
    }
    const html = comboSaved.map(combo=>{
      const totalQtd = combo.items.reduce((acc,item)=>acc+item.quantidade,0);
      const priced = combo.items.filter(item=>item.total!==null);
      const totalVal = priced.reduce((acc,item)=>acc+(item.total??0),0);
      const totalText = priced.length ? brl(totalVal) : '—';
      const updated = formatDateTime(combo.updated_at);
      return `
        <div class="combo-saved-card" data-id="${esc(combo.id)}">
          <div>
            <div class="fw-semibold">${esc(combo.name || 'Combo sem nome')}</div>
            <div class="combo-item-meta">
              <span>${combo.items.length} itens</span>
              <span>Total ${totalText}</span>
              <span>Qtd ${totalQtd}</span>
              ${updated ? `<span>Atualizado ${esc(updated)}</span>` : ''}
            </div>
          </div>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-success" data-action="load" data-id="${esc(combo.id)}"><i data-lucide="play"></i></button>
            <button type="button" class="btn btn-outline-secondary" data-action="duplicate" data-id="${esc(combo.id)}"><i data-lucide="copy"></i></button>
            <button type="button" class="btn btn-outline-danger" data-action="delete" data-id="${esc(combo.id)}"><i data-lucide="trash"></i></button>
          </div>
        </div>
      `;
    }).join('');
    refs.savedList.innerHTML = html;
    if(window.lucide) lucide.createIcons();
  }

  function pushItem(entry, options){
    const opts = Object.assign({ defer:false, skipToast:false }, options || {});
    const item = normalizeItem(entry);
    comboActive.items.push(item);
    if(!opts.defer){
      persistStorage();
      renderItems();
      if(!opts.skipToast && window.showToast){
        showToast('Item adicionado ao combo.', 'info');
      }
    }
    return item;
  }

  function resetItemForm(){
    if(refs.codigoInput) refs.codigoInput.value = '';
    if(refs.descricaoInput) refs.descricaoInput.value = '';
    if(refs.quantidadeInput) refs.quantidadeInput.value = '1';
    if(refs.valorInput) refs.valorInput.value = '';
    if(refs.codigoInput) refs.codigoInput.focus();
    clearSuggestions();
  }

  function addItemFromForm(){
    const codigo = refs.codigoInput?.value || '';
    const descricao = refs.descricaoInput?.value || '';
    const quantidade = refs.quantidadeInput?.value || '1';
    const valor = refs.valorInput?.value || '';
    pushItem({ codigo, descricao, quantidade, valor }, { skipToast:true });
    resetItemForm();
  }

  function removeItem(key){
    const idx = comboActive.items.findIndex(item => item.key === key);
    if(idx === -1) return;
    comboActive.items.splice(idx, 1);
    persistStorage();
    renderItems();
  }

  function editItem(key){
    const item = comboActive.items.find(entry => entry.key === key);
    if(!item) return;
    removeItem(key);
    if(refs.codigoInput) refs.codigoInput.value = item.codigo || '';
    if(refs.descricaoInput) refs.descricaoInput.value = item.descricao || '';
    if(refs.quantidadeInput) refs.quantidadeInput.value = item.quantidade;
    if(refs.valorInput) refs.valorInput.value = item.valor !== null ? item.valor.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) : '';
    refs.codigoInput?.focus();
  }

  function loadCombo(id, duplicate=false){
    clearSuggestions();
    const combo = comboSaved.find(entry => entry.id === id);
    if(!combo) return;
    const clone = normalizeCombo(combo);
    comboActive = {
      id: duplicate ? null : clone.id,
      name: duplicate ? `${clone.name} (cópia)` : clone.name,
      items: clone.items.map(normalizeItem),
    };
    if(refs.nameInput) refs.nameInput.value = comboActive.name;
    persistStorage();
    renderItems();
    updateStats();
  }

  function saveActiveCombo(){
    if(!comboActive.items.length){
      alert('Adicione ao menos um item antes de salvar o combo.');
      return;
    }
    const name = (refs.nameInput?.value || '').trim();
    if(!name){
      alert('Informe um nome para identificar o combo.');
      return;
    }
    const now = Date.now();
    if(comboActive.id){
      const existing = comboSaved.find(entry => entry.id === comboActive.id);
      if(existing){
        existing.name = name;
        existing.items = comboActive.items.map(normalizeItem);
        existing.updated_at = now;
      }else{
        comboSaved.unshift({
          id: comboActive.id,
          name,
          items: comboActive.items.map(normalizeItem),
          created_at: now,
          updated_at: now,
        });
      }
    }else{
      const id = generateId();
      comboActive.id = id;
      comboSaved.unshift({
        id,
        name,
        items: comboActive.items.map(normalizeItem),
        created_at: now,
        updated_at: now,
      });
    }
    comboActive.name = name;
    persistStorage();
    renderSaved();
    renderItems();
    if(window.showToast){
      showToast('Combo salvo nos favoritos.', 'success');
    }
  }

  function clearActiveCombo(){
    comboActive = { id: null, name: '', items: [] };
    if(refs.nameInput) refs.nameInput.value = '';
    persistStorage();
    renderItems();
    clearSuggestions();
  }

  function copyResumo(){
    if(!comboActive.items.length){
      alert('Nenhum item para copiar.');
      return;
    }
    const priced = comboActive.items.filter(item => item.total !== null);
    const totalVal = priced.reduce((acc,item)=>acc+(item.total??0),0);
    const header = `${comboActive.name || 'Combo sem nome'} (${comboActive.items.length} itens${priced.length ? ` · Total ${brl(totalVal)}` : ''})`;
    const lines = comboActive.items.map((item, idx)=>{
      const pieces = [];
      pieces.push(`${idx+1}.`);
      if(item.codigo) pieces.push(item.codigo);
      if(item.descricao) pieces.push('-', item.descricao);
      pieces.push(`x${item.quantidade}`);
      if(item.valor !== null) pieces.push('@', brl(item.valor));
      if(item.total !== null) pieces.push('→', brl(item.total));
      return pieces.join(' ');
    });
    const text = [header, ...lines].join('\n');
    if(navigator.clipboard?.writeText){
      navigator.clipboard.writeText(text).then(()=>{
        if(window.showToast){
          showToast('Resumo copiado.', 'success');
        }else{
          alert('Resumo copiado.');
        }
      }).catch(()=> alert('Não foi possível copiar o resumo.'));
    }else{
      alert('Clipboard não disponível neste navegador.');
    }
  }

  function applyToFilters(){
    if(!comboActive.items.length){
      alert('Monte o combo antes de aplicar nos filtros.');
      return;
    }
    const uniqueCodes = [...new Set(comboActive.items.map(item => item.codigo).filter(Boolean))];
    if(!uniqueCodes.length){
      alert('Nenhum código informado no combo.');
      return;
    }
    const pacoteField = document.getElementById('cbhpm-pacote');
    if(pacoteField){
      pacoteField.value = uniqueCodes.join('\n');
      pacoteField.dispatchEvent(new Event('input'));
    }
    const pickerInput = document.getElementById('cbhpmInput');
    if(pickerInput){
      pickerInput.focus();
    }
    if(window.showToast){
      showToast('Combo aplicado ao pacote da simulação.', 'success');
    }else{
      alert('Combo aplicado ao pacote.');
    }
  }

  function importFromClipboard(){
    if(!navigator.clipboard?.readText){
      alert('Clipboard API indisponível para importar.');
      return;
    }
    navigator.clipboard.readText().then(text=>{
      if(!text){
        alert('Área de transferência vazia.');
        return;
      }
      const lines = text.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
      if(!lines.length){
        alert('Nada para importar.');
        return;
      }
      let imported = 0;
      lines.forEach(line=>{
        const codeMatch = line.match(/(^|\s)(\d{4,})/);
        const codigo = codeMatch ? codeMatch[2].trim() : '';
        const quantidadeMatch = line.match(/x\s*(\d+)/i) || line.match(/(\d+)\s*(?:un|it|qty)/i);
        const quantidade = quantidadeMatch ? quantidadeMatch[1] : '1';
        const valorMatch = line.match(/(\d{1,3}(?:\.\d{3})*(?:,\d{2})|\d+,\d{2})/);
        const valor = valorMatch ? valorMatch[1] : '';
        const descricao = codigo ? line.replace(codigo, '').replace(/x\s*\d+/i, '').replace(valor || '', '').trim() : line;
        pushItem({ codigo, descricao, quantidade, valor }, { defer:true, skipToast:true });
        imported += 1;
      });
      if(imported){
        persistStorage();
        renderItems();
        clearSuggestions();
        if(window.showToast){
          showToast(`${imported} item(s) importados do clipboard.`, 'info');
        }
      }else{
        alert('Não foi possível interpretar os itens copiados.');
      }
    }).catch(()=> alert('Falha ao ler da área de transferência.'));
  }

  function toggleTips(){
    if(!refs.tipsBox) return;
    const hidden = refs.tipsBox.classList.contains('d-none');
    if(hidden){
      refs.tipsBox.classList.remove('d-none');
      refs.tipsBtn?.setAttribute('aria-expanded', 'true');
    }else{
      refs.tipsBox.classList.add('d-none');
      refs.tipsBtn?.setAttribute('aria-expanded', 'false');
    }
  }

  function clearSaved(){
    if(!comboSaved.length) return;
    if(!confirm('Remover todos os combos salvos?')){
      return;
    }
    comboSaved = [];
    persistStorage();
    renderSaved();
  }

  function handleSavedAction(evt){
    const btn = evt.target.closest('button[data-action]');
    if(!btn) return;
    const action = btn.getAttribute('data-action');
    const id = btn.getAttribute('data-id');
    if(!id) return;
    if(action === 'load'){
      loadCombo(id, false);
    }else if(action === 'duplicate'){
      loadCombo(id, true);
    }else if(action === 'delete'){
      comboSaved = comboSaved.filter(entry => entry.id !== id);
      persistStorage();
      renderSaved();
    }
  }

  refs.codigoSuggest?.addEventListener('mousedown', evt => {
    const itemEl = evt.target.closest('.combo-suggest-item');
    if(!itemEl) return;
    evt.preventDefault();
    const idx = Number(itemEl.dataset.index || -1);
    if(idx >= 0 && idx < comboSuggestState.results.length){
      applySuggestion(comboSuggestState.results[idx]);
    }
  });

  if(refs.codigoInput){
    refs.codigoInput.addEventListener('input', evt => {
      scheduleSuggestions(evt.target.value);
    });
    refs.codigoInput.addEventListener('focus', evt => {
      const value = (evt.target.value || '').trim();
      if(value.length >= 2){
        scheduleSuggestions(value);
      }
    });
    refs.codigoInput.addEventListener('keydown', evt => {
      if(refs.codigoSuggest?.hidden) return;
      if(evt.key === 'ArrowDown'){
        evt.preventDefault();
        comboSuggestState.active = Math.min(comboSuggestState.active + 1, comboSuggestState.results.length - 1);
        renderSuggestions();
      }else if(evt.key === 'ArrowUp'){
        evt.preventDefault();
        comboSuggestState.active = Math.max(comboSuggestState.active - 1, 0);
        renderSuggestions();
      }else if(evt.key === 'Enter'){
        if(comboSuggestState.active >= 0 && comboSuggestState.active < comboSuggestState.results.length){
          evt.preventDefault();
          applySuggestion(comboSuggestState.results[comboSuggestState.active]);
        }
      }else if(evt.key === 'Escape'){
        clearSuggestions();
      }
    });
    refs.codigoInput.addEventListener('blur', () => {
      setTimeout(()=> clearSuggestions(), 150);
    });
  }

  modalEl.addEventListener('click', evt => {
    const listEl = refs.codigoSuggest;
    if(!listEl || listEl.hidden) return;
    if(!listEl.contains(evt.target) && evt.target !== refs.codigoInput){
      clearSuggestions();
    }
  });

  modalEl.addEventListener('hidden.bs.modal', () => {
    clearSuggestions();
  });

  modalEl.addEventListener('shown.bs.modal', () => {
    refs.codigoInput?.focus();
  });

  window.comboBuilder = window.comboBuilder || {};
  window.comboBuilder.open = function(){
    const modalInst = getModalInstance();
    clearSuggestions();
    if(modalInst){
      modalInst.show();
    }else if(modalEl){
      modalEl.classList.add('show');
    }
  };
  window.comboBuilder.addItem = function(entry, options){
    if(!entry) return null;
    const opts = Object.assign({ skipToast:false, openModal:true }, options || {});
    if(opts.openModal !== false){
      const modalInst = getModalInstance();
      if(modalInst){
        modalInst.show();
      }else if(modalEl){
        modalEl.classList.add('show');
      }
    }
    const item = pushItem(entry, { skipToast: opts.skipToast });
    clearSuggestions();
    if(!window.showToast && !opts.skipToast){
      alert('Item adicionado ao combo.');
    }
    return item;
  };

  loadStorage();
  if(refs.nameInput) refs.nameInput.value = comboActive.name || '';
  renderItems();
  renderSaved();

  if(refs.itemForm){
    refs.itemForm.addEventListener('submit', evt=>{
      evt.preventDefault();
      addItemFromForm();
    });
  }
  refs.list?.addEventListener('click', evt=>{
    const btn = evt.target.closest('button[data-action]');
    if(!btn) return;
    const key = btn.getAttribute('data-key');
    if(!key) return;
    const action = btn.getAttribute('data-action');
    if(action === 'remove'){
      removeItem(key);
    }else if(action === 'edit'){
      editItem(key);
    }
  });
  refs.saveBtn?.addEventListener('click', saveActiveCombo);
  refs.clearBtn?.addEventListener('click', clearActiveCombo);
  refs.copyBtn?.addEventListener('click', copyResumo);
  refs.applyBtn?.addEventListener('click', applyToFilters);
  refs.importBtn?.addEventListener('click', importFromClipboard);
  refs.tipsBtn?.addEventListener('click', toggleTips);
  refs.clearSavedBtn?.addEventListener('click', clearSaved);
  refs.savedList?.addEventListener('click', handleSavedAction);
  refs.nameInput?.addEventListener('input', ()=>{
    comboActive.name = refs.nameInput.value;
    persistStorage();
  });
})();

function loadSavedScenarios(){
  try{
    const raw = localStorage.getItem(SCENARIO_STORAGE_KEY);
    if(!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  }catch(err){
    console.warn('Falha ao carregar cenários salvos:', err);
    return [];
  }
}

function persistSavedScenarios(list){
  try{
    localStorage.setItem(SCENARIO_STORAGE_KEY, JSON.stringify(list));
  }catch(err){
    console.warn('Não foi possível salvar o cenário localmente.', err);
  }
}

function scenarioMetricsFromResult(result){
  if(!result || typeof result !== 'object') return null;
  const total = _toNumber(result.total_final || result.total);
  let excedente = 0;
  let tetoBase = 0;
  const alertas = Array.isArray(result.teto_alertas) ? result.teto_alertas : [];
  if(alertas.length){
    excedente = alertas.reduce((acc, alerta)=> acc + _toNumber(alerta.excedente), 0);
    tetoBase = alertas.reduce((acc, alerta)=> acc + _toNumber(alerta.teto_valor_total), 0);
  }else if(_hasValue(result.teto_excedente)){
    excedente = _toNumber(result.teto_excedente);
    tetoBase = _toNumber(result.teto_valor_total);
  }
  const excedPct = tetoBase > 0 ? (excedente / tetoBase * 100) : null;
  return { total, excedente, tetoBase, excedPct };
}

function formatDiffCurrency(value){
  if(!Number.isFinite(value)) return '—';
  const sign = value > 0 ? '+' : '';
  return `${sign}${brl(value)}`;
}

function formatDiffPercent(value){
  if(!Number.isFinite(value)) return null;
  const sign = value > 0 ? '+' : '';
  return `${sign}${value.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}%`;
}

function prepareItemsForView(items, state){
  const opts = state || {};
  let arr = Array.isArray(items) ? items.map(item=>({ ...item })) : [];
  if(opts.onlyExced){
    arr = arr.filter(item=>{
      const status = String(item.teto_status || '').toUpperCase();
      if(status === 'ULTRAPASSA') return true;
      return _toNumber(item.teto_excedente) > 0;
    });
  }
  const sortKey = opts.sort || 'codigo';
  arr.sort((a,b)=>{
    switch(sortKey){
      case 'excedente_desc':{
        const diff = _toNumber(b.teto_excedente) - _toNumber(a.teto_excedente);
        if(diff !== 0) return diff;
        return String(a.codigo||'').localeCompare(String(b.codigo||''), 'pt-BR', {numeric:true});
      }
      case 'total_desc':{
        const diff = _toNumber(b.total_final || b.total) - _toNumber(a.total_final || a.total);
        if(diff !== 0) return diff;
        return String(a.codigo||'').localeCompare(String(b.codigo||''), 'pt-BR', {numeric:true});
      }
      default:
        return String(a.codigo||'').localeCompare(String(b.codigo||''), 'pt-BR', {numeric:true});
    }
  });
  return arr;
}

function initTooltips(root){
  if(!root || !window.bootstrap || !bootstrap.Tooltip) return;
  root.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=>{
    const instance = bootstrap.Tooltip.getInstance(el);
    if(instance) instance.dispose();
    new bootstrap.Tooltip(el);
  });
}

function highlightVersoes(versoes){
  const set = new Set((versoes || []).map(v=>String(v)));
  $$('.ver-chk').forEach(chk=>{
    const wrapper = chk.closest('.form-check');
    if(!wrapper) return;
    if(set.has(chk.value)){
      wrapper.classList.add('suggested');
    }else{
      wrapper.classList.remove('suggested');
    }
  });
}

function initChecklistFilter({ containerId, inputId, countId, checkboxSelector }){
  const container = document.getElementById(containerId);
  if(!container) return null;
  const searchInput = document.getElementById(inputId);
  const countEl = document.getElementById(countId);
  const items = [...container.querySelectorAll(checkboxSelector)].map(chk=>{
    const wrapper = chk.closest('[class*="col-"]') || chk.closest('.form-check');
    const text = (chk.nextElementSibling?.textContent || '').trim().toLowerCase();
    return { chk, wrapper, text };
  });

  function updateCount(){
    if(!countEl) return;
    const total = items.length;
    const selectedCount = items.filter(item=>item.chk.checked).length;
    const visibleCount = items.filter(item=>!item.wrapper?.hidden).length;
    let summary = selectedCount ? `${selectedCount}/${total} selecionado${selectedCount>1?'s':''}` : `${total} opções`;
    if(visibleCount !== total){
      summary += ` · ${visibleCount} visíveis`;
    }
    countEl.textContent = summary;
  }

  function applyFilter(){
    const term = (searchInput?.value || '').trim().toLowerCase();
    items.forEach(item=>{
      const match = !term || item.text.includes(term);
      if(item.wrapper){
        item.wrapper.hidden = !match;
      }
    });
    updateCount();
  }

  if(searchInput){
    searchInput.addEventListener('input', applyFilter);
    searchInput.addEventListener('search', applyFilter);
  }

  container.addEventListener('change', updateCount, true);
  applyFilter();

  return {
    updateCount,
    applyFilter
  };
}

/* ===== Versões (CBHPM) ===== */
function toggleAllVersoes(state){
  $$('.ver-chk').forEach(chk=>{ chk.checked = !!state; });
  if(typeof window._updateVersoesResumo === 'function'){
    window._updateVersoesResumo();
  }
}

/* ===== Exportar/Copiar ===== */
function collectResults(){
  const table=document.querySelector('.table-responsive table');
  if(!table||!table.tHead||!table.tBodies.length)return [];
  const head=[...table.tHead.rows[0].cells].map(th=>th.textContent.trim());
  const body=[...table.tBodies[0].rows].map(tr=>[...tr.cells].map(td=>td.textContent.trim()));
  return [head].concat(body);
}
function exportCSV(){
  const rows=collectResults(); if(!rows.length)return;
  const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  download(`resultados-${stamp}.csv`, toCSV(rows));
}
function copyResults(){
  const rows=collectResults(); if(!rows.length)return;
  navigator.clipboard.writeText(toCSV(rows)).then(()=>{ window.showToast?showToast('Copiado para a área de transferência.','success'):alert('Copiado.'); });
}

/* ===== Modal Detalhe ===== */
function openDetalhe(codigo){
  const isCBHPM   = {{ is_cbhpm|default(false)|tojson }};
  const tabelaNome= {{ tabela_nome|default(None)|tojson }};
  const ufSel     = {{ selected_uf|default('')|tojson }};
  const versoes   = {{ selected_versoes|default([])|tojson }};

  const modalEl=document.getElementById('detalheModal');
  const modalBody=modalEl.querySelector('.modal-body');
  modalBody.innerHTML='<div class="text-center text-muted py-4">Carregando...</div>';
  new bootstrap.Modal(modalEl).show();
  const setModalContent = (html)=>{
    modalBody.innerHTML = html;
    if(HAS_TUSS_ROL){
      const rolSlot = document.createElement('div');
      rolSlot.className = 'mb-3';
      modalBody.prepend(rolSlot);
      renderRolStatus(rolSlot, codigo);
    }
  };

  if(isCBHPM){
    const params=new URLSearchParams();
    params.set('codigo',codigo);
    if(tabelaNome) params.set('tabela_nome', tabelaNome);
    if(ufSel) params.set('uf',ufSel);
    (versoes||[]).forEach(v=>params.append('versoes',v));
    fetch('/api/cbhpm/detalhe?'+params.toString())
      .then(r=>r.json()).then(data=>{
        const items=(data&&data.items)?data.items:[];
        if(!items.length){
          setModalContent('<div class="empty"><i data-lucide="file-x"></i> Sem dados para este código.</div>');
          if(window.lucide)lucide.createIcons();
          return;
        }
        let html='<div class="table-responsive"><table class="table table-sm table-striped align-middle mb-0">';
        html+='<thead class="table-light"><tr><th style="width:160px">Versão</th><th class="text-end">Valor</th></tr></thead><tbody>';
        items.forEach(it=>{ html+='<tr><td>'+ (it.versao||'-') +'</td><td class="text-end">'+ brl(it.valor) +'</td></tr>'; });
        html+='</tbody></table></div>';
        if(data.summary){
          html+='<div class="mt-3 small text-muted">Mín: <strong>'+brl(data.summary.min)+'</strong> · Média: <strong>'+brl(data.summary.avg)+'</strong> · Máx: <strong>'+brl(data.summary.max)+'</strong> · N: <strong>'+ (data.summary.count??0) +'</strong></div>';
        }
        setModalContent(html);
        if(window.lucide)lucide.createIcons();
      })
      .catch(()=>{
        setModalContent('<div class="alert alert-danger">Erro ao carregar detalhes.</div>');
      });
  }else{
    const params=new URLSearchParams(); if(tabelaNome)params.set('tabela_nome',tabelaNome); params.set('codigo',codigo); if(ufSel)params.set('uf',ufSel);
    params.set('sort','valor'); params.set('order','asc'); params.set('page','1'); params.set('page_size','200');
    fetch('/api/procedimentos/detalhe?'+params.toString())
      .then(r=>r.json()).then(data=>{
        const items=(data&&data.items)?data.items:[];
        if(!items.length){
          setModalContent('<div class="empty"><i data-lucide="file-x"></i> Sem dados para este código.</div>');
          if(window.lucide)lucide.createIcons();
          return;
        }
        let html='<div class="table-responsive"><table class="table table-sm table-striped align-middle mb-0">';
        html+='<thead class="table-light"><tr><th style="width:160px">Prestador</th><th class="text-center" style="width:80px">UF</th><th class="text-end" style="width:140px">Valor</th></tr></thead><tbody>';
        items.forEach(it=>{ html+='<tr><td>'+ (it.prestador||'-') +'</td><td class="text-center">'+ (it.uf||'-') +'</td><td class="text-end">'+ brl(it.valor) +'</td></tr>'; });
        html+='</tbody></table></div>';
        if(data.summary){
          html+='<div class="mt-3 small text-muted">Mín: <strong>'+brl(data.summary.min)+'</strong> · Média: <strong>'+brl(data.summary.avg)+'</strong> · Máx: <strong>'+brl(data.summary.max)+'</strong> · N: <strong>'+ (data.summary.count??0) +'</strong></div>';
        }
        setModalContent(html);
        if(window.lucide)lucide.createIcons();
      })
      .catch(()=>{
        setModalContent('<div class="alert alert-danger">Erro ao carregar detalhes.</div>');
      });
  }
}

/* ===== Simuladores ===== */
const parsePacote = (t)=> (t||'').split(/\r?\n|[;,]+/g).map(s=>s.trim()).filter(Boolean);
const VIA_PCT_OPTIONS = ['100','70','50','30'];
const _hasValue = (value)=> !(value === null || value === undefined || value === '' || value === 'None');
const _toNumber = (value)=> {
  if(value === null || value === undefined || value === '' || value === 'None') return 0;
  const n = Number(value);
  return Number.isFinite(n) ? n : 0;
};

window._cbhpmHasResult = window._cbhpmHasResult || false;
window._cbhpmLastPayload = window._cbhpmLastPayload || null;
window._cbhpmViaPctByCode = window._cbhpmViaPctByCode || {};
window._cbhpmViewState = window._cbhpmViewState || { onlyExced:false, sort:'codigo' };
window._cbhpmSavedScenarios = window._cbhpmSavedScenarios || loadSavedScenarios();
window._cbhpmBaselineScenario = window._cbhpmBaselineScenario || null;
window._cbhpmCurrentResult = window._cbhpmCurrentResult || null;

const _normalizeCode = (code)=> (code||'').toString().trim();
const _formatPctLabel = (pct)=> `${Number(pct||'100').toLocaleString('pt-BR',{minimumFractionDigits:0,maximumFractionDigits:2})}%`;

function _setViaPctFor(code, pct){
  const key = _normalizeCode(code);
  if(!key || key === '__default__') return;
  window._cbhpmViaPctByCode[key] = String(pct);
}

function _getViaPctFor(code){
  const key = _normalizeCode(code);
  if(!key) return '100';
  return window._cbhpmViaPctByCode[key] || '100';
}

function _pruneViaPctStore(activeCodes){
  const keep = new Set(activeCodes.map(_normalizeCode));
  Object.keys(window._cbhpmViaPctByCode).forEach(key=>{
    if(!keep.has(key)){
      delete window._cbhpmViaPctByCode[key];
    }
  });
}

function _viaSummary(map){
  const numericValues = Object.values(map || {}).map(v=> Number(v)).filter(v=> Number.isFinite(v));
  if(!numericValues.length) return '100%';
  const unique = new Set(numericValues);
  if(unique.size === 1){
    const val = unique.values().next().value;
    return _formatPctLabel(val);
  }
  return 'Personalizado';
}

function simularCBHPM(){
  const payload = getCBHPMPayload();
  const out=document.getElementById('cbhpm-out');
  if(!payload.codigo && (!payload.codigos || !payload.codigos.length) && (!payload.dtp_items || !payload.dtp_items.length)){
    out.innerHTML='<div class="alert alert-warning">Informe ao menos um codigo ou selecione itens.</div>';
    window._cbhpmHasResult = false;
    window._cbhpmLastPayload = null;
    return;
  }
  window._cbhpmLastPayload = payload;
  out.innerHTML='<div class="soft">Calculando...</div>';

  fetch('/api/simulacao_cbhpm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
    .then(r=>r.json())
    .then(data=>{
      window._cbhpmHasResult = !data.error;
      if(data.error){
        window._cbhpmCurrentResult = null;
        out.innerHTML='<div class="alert alert-danger">'+data.error+'</div>';
        return;
      }
      window._cbhpmCurrentResult = data;
      const state = window._cbhpmViewState || (window._cbhpmViewState = { onlyExced:false, sort:'codigo' });

      const serverMapRaw = (data.via_entrada_pcts && typeof data.via_entrada_pcts === 'object') ? data.via_entrada_pcts : {};
      const serverMap = {};
      Object.entries(serverMapRaw).forEach(([key,val])=>{
        const normKey = _normalizeCode(key);
        if(!normKey || normKey === '__default__') return;
        serverMap[normKey] = String(val);
      });
      Object.entries(serverMap).forEach(([key,val])=> _setViaPctFor(key, val));

      const tetoAlertas = Array.isArray(data.teto_alertas) ? data.teto_alertas : [];
      const hasTetoInfo = Array.isArray(data.itens)
        ? data.itens.some(it => it && it.origem !== 'dtp' && _hasValue(it.teto_valor_total))
        : _hasValue(data.teto_valor_total);
      const tetoStatusRaw = data.teto_status || (tetoAlertas.length ? 'ULTRAPASSA' : 'OK');
      const tetoStatus = String(tetoStatusRaw || 'OK').toUpperCase();
      const excedeuTeto = tetoStatus === 'ULTRAPASSA';
      const excedenteTotal = tetoAlertas.reduce((acc, alerta)=> acc + _toNumber(alerta.excedente), 0);
      const totalTetoBase = tetoAlertas.reduce((acc, alerta)=> acc + _toNumber(alerta.teto_valor_total), 0);
      const excedenteTotalPct = totalTetoBase > 0 ? (excedenteTotal / totalTetoBase * 100) : null;
      const statusTooltip = excedeuTeto
        ? `Total excede o teto em ${brl(excedenteTotal)}${Number.isFinite(excedenteTotalPct)?` (${excedenteTotalPct.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}%)`:''}`
        : 'Todos os itens dentro do teto cadastrado';

      if(Array.isArray(data.itens)){
        const viaSummary = _viaSummary(serverMap);
        const statusBadge = !hasTetoInfo
          ? '—'
          : (excedeuTeto
              ? `<span class="badge bg-danger-subtle text-danger" data-bs-toggle="tooltip" data-bs-title="${esc(statusTooltip)}"><i class="bi bi-exclamation-triangle me-1"></i>Ultrapassa o teto</span>`
              : `<span class="badge bg-success-subtle text-success" data-bs-toggle="tooltip" data-bs-title="${esc(statusTooltip)}"><i class="bi bi-check-circle me-1"></i>Dentro do teto</span>`);
        let html='';
        if(tetoAlertas.length){
          const list = tetoAlertas.map(alerta=>{
            const excedenteFmt = brl(alerta.excedente);
            const excedPct = alerta.pct_excedente ? pct(alerta.pct_excedente) : null;
            const pctInfo = excedPct ? ` (<strong>${excedPct}</strong>)` : '';
            return `<li><strong>${esc(alerta.codigo||'-')}</strong> — ${esc(alerta.descricao||'-')}: total ${brl(alerta.total_calculado)} × teto ${brl(alerta.teto_valor_total)} ⇒ excedente <strong>${excedenteFmt}</strong>${pctInfo}</li>`;
          }).join('');
          html += `<div class="alert alert-warning d-flex align-items-start gap-2 mb-3"><i class="bi bi-exclamation-triangle-fill fs-5"></i><div><strong>Ultrapassa o teto CBHPM</strong><ul class="mb-0 mt-2 ps-3">${list}</ul></div></div>`;
        } else if(hasTetoInfo){
          html += '<div class="alert alert-info d-flex align-items-start gap-2 mb-3"><i class="bi bi-info-circle-fill fs-5"></i><div>Todos os itens ficaram dentro do teto CBHPM cadastrado.</div></div>';
        }

        html += '<div class="d-flex flex-wrap gap-2 align-items-center mb-2">'
             + '<div class="form-check form-switch mb-0">'
             + `<input class="form-check-input" type="checkbox" id="cbhpmOnlyExced" ${state.onlyExced?'checked':''}>`
             + '<label class="form-check-label" for="cbhpmOnlyExced">Somente ultrapassando</label>'
             + '</div>'
             + '<div class="input-group input-group-sm" style="max-width:260px;">'
             + '<span class="input-group-text">Ordenar</span>'
             + '<select class="form-select" id="cbhpmSort">'
             + `<option value="codigo" ${state.sort==='codigo'?'selected':''}>Código</option>`
             + `<option value="excedente_desc" ${state.sort==='excedente_desc'?'selected':''}>Excedente (maior)</option>`
             + `<option value="total_desc" ${state.sort==='total_desc'?'selected':''}>Total (maior)</option>`
             + '</select>'
             + '</div>'
             + '<button type="button" class="btn btn-outline-secondary btn-sm" id="cbhpmResetView">Limpar filtros</button>'
             + '</div>';

        html+='<div class="table-responsive mt-2" style="max-height:70vh"><table class="table table-sm table-striped align-middle mb-0">';
        html+='<thead class="table-light"><tr><th style="width:110px">Código</th><th>Descrição</th>';
        {% if show_tuss_rol %}
        html+='<th class="text-center" style="width:110px">ROL ANS</th>';
        {% endif %}
        html+='<th class="text-end">Porte</th><th class="text-end">Filme</th><th class="text-end">UCO</th><th class="text-end">Porte AN</th><th class="text-end">Auxiliares</th><th class="text-center" style="width:150px">Via entrada</th><th class="text-end">Total</th><th class="text-end">Teto</th><th class="text-center">Status</th><th class="text-end">Excedente</th></tr></thead><tbody>';

        const activeCodes = new Set();
        const tableItems = prepareItemsForView(data.itens, state);
        tableItems.forEach(it=>{
          const isDtp = (it.origem === 'dtp');
          const descricao = (it.descricao||'-');
          const descHtml = isDtp ? `${descricao} <span class="badge bg-info-subtle text-info ms-1">DTP</span>` : descricao;
          {% if show_tuss_rol %}
          const rolData = (!isDtp && (it.rol || it.tuss_rol)) ? (it.rol || it.tuss_rol) : null;
          let rolHtml = '-';
          if(isDtp){
            rolHtml = '-';
          }else if(rolData){
            const badgeClass = rolData.consta ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary';
            const label = rolData.consta ? 'Sim' : 'Não';
            const tooltip = rolData.descricao ? ` data-bs-toggle="tooltip" data-bs-title="${esc(rolData.descricao)}"` : '';
            rolHtml = `<span class="badge ${badgeClass}"${tooltip}>${label}</span>`;
          }else{
            rolHtml = '<span class="text-muted">—</span>';
          }
          {% endif %}
          const porte = isDtp ? '-' : brl(it.total_porte);
          const filme = isDtp ? '-' : brl(it.total_filme);
          const uco = isDtp ? '-' : brl(it.total_uco);
          const porteAn = isDtp ? '-' : brl(it.total_porte_an);
          const aux = isDtp ? '-' : brl(it.total_auxiliares);
          const totalFinal = brl(it.total_final || it.total);
          const totalOriginal = _hasValue(it.total_original) ? brl(it.total_original) : totalFinal;
          let totalHtml = totalFinal;
          if(!isDtp && totalOriginal !== totalFinal){
            totalHtml += `<div class="small text-muted">Orig. ${totalOriginal}</div>`;
          }
          const codeKey = _normalizeCode(it.codigo);
          if(!isDtp && codeKey){
            activeCodes.add(codeKey);
            if(!(codeKey in serverMap)){
              const current = _getViaPctFor(codeKey);
              _setViaPctFor(codeKey, current);
              serverMap[codeKey] = current;
            }
          }
          const currentPct = isDtp ? '100' : (serverMap[codeKey] || _getViaPctFor(codeKey));
          const selectHtml = isDtp ? '-' : `<select class="form-select form-select-sm via-selector" data-code="${codeKey}">${VIA_PCT_OPTIONS.map(opt=>`<option value="${opt}" ${opt===String(currentPct)?'selected':''}>${opt}%</option>`).join('')}</select>`;
          const tetoValor = (!isDtp && _hasValue(it.teto_valor_total)) ? brl(it.teto_valor_total) : '-';
          let excedenteValor = (!isDtp && _hasValue(it.teto_excedente)) ? brl(it.teto_excedente) : '-';
          const excedentePct = (!isDtp && _hasValue(it.teto_pct_excedente)) ? pct(it.teto_pct_excedente) : null;
          const itemStatus = (!isDtp && it.teto_status) ? String(it.teto_status).toUpperCase() : 'OK';
          const rowClass = (!isDtp && itemStatus === 'ULTRAPASSA') ? 'row-excede' : '';
          const tetoClass = (!isDtp && itemStatus === 'ULTRAPASSA') ? 'text-end text-danger fw-semibold' : 'text-end';
          const excedClass = (!isDtp && itemStatus === 'ULTRAPASSA') ? 'text-end text-danger fw-semibold' : 'text-end';
          if(excedenteValor === '-' && (!isDtp && itemStatus === 'ULTRAPASSA')){
            excedenteValor = 'Ultrapassa';
          }
          if(excedenteValor !== '-' && excedenteValor !== 'Ultrapassa' && excedentePct){
            excedenteValor += ` (${excedentePct})`;
          }
          const statusTooltipRow = itemStatus === 'ULTRAPASSA'
            ? `Total ${totalFinal} ultrapassa teto ${tetoValor}${excedenteValor && excedenteValor !== 'Ultrapassa'?` em ${excedenteValor}`:''}`
            : `Dentro do teto ${tetoValor}`;
          const statusHtml = isDtp ? '-' : (itemStatus === 'ULTRAPASSA'
            ? `<span class="badge bg-danger-subtle text-danger" data-bs-toggle="tooltip" data-bs-title="${esc(statusTooltipRow)}"><i class="bi bi-exclamation-triangle me-1"></i>Ultrapassa</span>`
            : `<span class="badge bg-success-subtle text-success" data-bs-toggle="tooltip" data-bs-title="${esc(statusTooltipRow)}"><i class="bi bi-check-circle me-1"></i>OK</span>`);
      html+='<tr class="'+rowClass+'">'
         +  '<td>'+ (it.codigo||'-') +'</td>'
             +  '<td>'+ descHtml +'</td>'
             {% if show_tuss_rol %}
             +  '<td class="text-center">'+ rolHtml +'</td>'
             {% endif %}
             +  '<td class="text-end">'+ porte +'</td>'
             +  '<td class="text-end">'+ filme +'</td>'
             +  '<td class="text-end">'+ uco +'</td>'
             +  '<td class="text-end">'+ porteAn +'</td>'
             +  '<td class="text-end">'+ aux +'</td>'
             +  `<td class="text-center">${selectHtml}</td>`
             +  '<td class="text-end fw-semibold">'+ totalHtml +'</td>'
             +  `<td class="${tetoClass}">${tetoValor}</td>`
             +  `<td class="text-center">${statusHtml}</td>`
             +  `<td class="${excedClass}">${excedenteValor}</td>`
             +  '</tr>';
        });

        _pruneViaPctStore([...activeCodes]);

        html+='</tbody></table></div>';
        const totalOriginalAgg = brl(data.total_original || data.total);
        const totalFinalAgg = brl(data.total_final || data.total);
        const totalTetoBase = tetoAlertas.reduce((acc, alerta)=> acc + _toNumber(alerta.teto_valor_total), 0);
        const excedenteTotalPct = totalTetoBase > 0 ? pct((excedenteTotal / totalTetoBase) * 100) : null;
        html+='<div class="mt-3"><span class="mini-label">Porte:</span> <strong>'+brl(data.total_porte)+'</strong> · '
             + '<span class="mini-label">Filme:</span> <strong>'+brl(data.total_filme)+'</strong> · '
             + '<span class="mini-label">UCO:</span> <strong>'+brl(data.total_uco)+'</strong> · '
             + '<span class="mini-label">Porte AN:</span> <strong>'+brl(data.total_porte_an)+'</strong> · '
             + '<span class="mini-label">Aux.:</span> <strong>'+brl(data.total_auxiliares)+'</strong> · '
             + '<span class="mini-label">Total original:</span> <strong>'+totalOriginalAgg+'</strong> · '
             + '<span class="mini-label">Total final:</span> <strong>'+totalFinalAgg+'</strong> · '
             + '<span class="mini-label">Teto:</span> '+ statusBadge;
        if(excedenteTotal > 0){
          html += ' · <span class="mini-label">Excedente acumulado:</span> <strong>'+brl(excedenteTotal)+'</strong>'+ (excedenteTotalPct ? ` (<strong>${excedenteTotalPct}</strong>)` : '');
        }
        html+='</div>';
        const baseline = window._cbhpmBaselineScenario;
        if(baseline && baseline.metrics){
          const currentMetrics = scenarioMetricsFromResult(data);
          if(currentMetrics){
            const baseMetrics = baseline.metrics || {};
            const diffTotal = Number.isFinite(currentMetrics.total) && Number.isFinite(baseMetrics.total) ? currentMetrics.total - baseMetrics.total : NaN;
            const diffExced = Number.isFinite(currentMetrics.excedente) && Number.isFinite(baseMetrics.excedente) ? currentMetrics.excedente - baseMetrics.excedente : NaN;
            const diffPct = Number.isFinite(currentMetrics.excedPct) && Number.isFinite(baseMetrics.excedPct) ? (currentMetrics.excedPct - baseMetrics.excedPct) : NaN;
            const pctLabel = formatDiffPercent(diffPct);
            html += `<div class="soft mt-2">Comparação com “${esc(baseline.name || 'Sem nome')}”: Total ${formatDiffCurrency(diffTotal)} · Excedente ${formatDiffCurrency(diffExced)}${pctLabel?` · Δ% excedente ${pctLabel}`:''}</div>`;
          }
        }
        html+='<div class="soft mt-1">UCO usado: <strong>'+ (data.uco_valor||'-') +'</strong> · Porte: <strong>'+ (data.porte_tabela_usada||'-') +'</strong> · Porte AN: <strong>'+ (data.porte_an_tabela_usada||'-') +'</strong> · Redutor via entrada: <strong>'+ viaSummary +'</strong></div>';
        out.innerHTML=html;
        if(window.lucide)lucide.createIcons();
        initTooltips(out);
        out.querySelectorAll('.via-selector').forEach(sel=>{
          sel.addEventListener('change', (ev)=>{
            const code = ev.target.dataset.code;
            const val = ev.target.value;
            _setViaPctFor(code, val);
            simularCBHPM();
          });
        });
        const filterToggle = out.querySelector('#cbhpmOnlyExced');
        if(filterToggle){
          filterToggle.addEventListener('change', ()=>{
            state.onlyExced = filterToggle.checked;
            simularCBHPM();
          });
        }
        const sortSelect = out.querySelector('#cbhpmSort');
        if(sortSelect){
          sortSelect.addEventListener('change', ()=>{
            state.sort = sortSelect.value;
            simularCBHPM();
          });
        }
        const resetBtn = out.querySelector('#cbhpmResetView');
        if(resetBtn){
          resetBtn.addEventListener('click', ()=>{
            state.onlyExced = false;
            state.sort = 'codigo';
            simularCBHPM();
          });
        }
        return;
      }

      const baseCode = _normalizeCode(data.codigo);
      if(baseCode && !(baseCode in serverMap)){
        const fallbackPct = _getViaPctFor(baseCode);
        _setViaPctFor(baseCode, fallbackPct);
        serverMap[baseCode] = fallbackPct;
      }
      const basePctSource = baseCode ? serverMap[baseCode] : (data.via_entrada_pct || '100');
      const numericBasePct = Number(basePctSource);
      const pctLabel = Number.isFinite(numericBasePct) ? _formatPctLabel(numericBasePct) : '100%';

      const statusBadgeSingle = !hasTetoInfo
        ? '—'
        : (tetoStatus === 'ULTRAPASSA'
            ? `<span class="badge bg-danger-subtle text-danger" data-bs-toggle="tooltip" data-bs-title="${esc(statusTooltip)}"><i class="bi bi-exclamation-triangle me-1"></i>Ultrapassa o teto</span>`
            : `<span class="badge bg-success-subtle text-success" data-bs-toggle="tooltip" data-bs-title="${esc(statusTooltip)}"><i class="bi bi-check-circle me-1"></i>Dentro do teto</span>`);
      const totalOriginalSingle = brl(data.total_original || data.total);
      const totalFinalSingle = brl(data.total_final || data.total);
      const tetoValorSingle = _hasValue(data.teto_valor_total) ? brl(data.teto_valor_total) : '-';
      const excedenteSingle = _hasValue(data.teto_excedente) ? brl(data.teto_excedente) : '-';
      const excedPctSingle = _hasValue(data.teto_pct_excedente) ? pct(data.teto_pct_excedente) : null;
      const tetoCardSubtitle = !hasTetoInfo
        ? '-'
        : (tetoStatus === 'ULTRAPASSA'
            ? (excedenteSingle !== '-' ? `Excedente ${excedenteSingle}${excedPctSingle?' ('+excedPctSingle+')':''}` : 'Ultrapassa o teto')
            : 'Dentro do limite');
      {% if show_tuss_rol %}
      const rolInfoSingle = data.rol || data.tuss_rol || null;
      let rolBadgeSingle = '<span class="text-muted">Sem correlação ROL</span>';
      if(rolInfoSingle){
        const badgeClass = rolInfoSingle.consta ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary';
        const label = rolInfoSingle.consta ? 'Sim' : 'Não';
        const tooltip = rolInfoSingle.descricao ? ` data-bs-toggle="tooltip" data-bs-title="${esc(rolInfoSingle.descricao)}"` : '';
        rolBadgeSingle = `<span class="badge ${badgeClass}"${tooltip}>${label}</span>`;
      }
      {% endif %}

      let html='';
      if(tetoAlertas.length){
        const list = tetoAlertas.map(alerta=>{
          const excedenteFmt = brl(alerta.excedente);
          const excedPct = alerta.pct_excedente ? pct(alerta.pct_excedente) : null;
          const pctInfo = excedPct ? ` (<strong>${excedPct}</strong>)` : '';
          return `<li><strong>${esc(alerta.codigo||'-')}</strong> — ${esc(alerta.descricao||'-')}: total ${brl(alerta.total_calculado)} × teto ${brl(alerta.teto_valor_total)} ⇒ excedente <strong>${excedenteFmt}</strong>${pctInfo}</li>`;
        }).join('');
        html += `<div class="alert alert-warning d-flex align-items-start gap-2 mb-3"><i class="bi bi-exclamation-triangle-fill fs-5"></i><div><strong>Ultrapassa o teto CBHPM</strong><ul class="mb-0 mt-2 ps-3">${list}</ul></div></div>`;
      } else if(hasTetoInfo){
        html += '<div class="alert alert-info d-flex align-items-start gap-2 mb-3"><i class="bi bi-info-circle-fill fs-5"></i><div>O procedimento permaneceu dentro do teto CBHPM cadastrado.</div></div>';
      }

      html+='<div class="row g-3">';
      html+='<div class="col-12 col-lg-3"><div class="card p-3"><div class="mini-label">Total Porte</div><div class="fs-5 fw-semibold">'+brl(data.total_porte)+'</div></div></div>';
      html+='<div class="col-12 col-lg-3"><div class="card p-3"><div class="mini-label">Total Filme</div><div class="fs-5 fw-semibold">'+brl(data.total_filme)+'</div></div></div>';
      html+='<div class="col-12 col-lg-3"><div class="card p-3"><div class="mini-label">Total UCO</div><div class="fs-5 fw-semibold">'+brl(data.total_uco)+'</div></div></div>';
      html+='<div class="col-12 col-lg-3"><div class="card p-3"><div class="mini-label">Total Porte AN</div><div class="fs-5 fw-semibold">'+brl(data.total_porte_an)+'</div></div></div>';
      html+='<div class="col-12 col-lg-3"><div class="card p-3'+(data.teto_excedido?' border border-danger-subtle':'')+'"><div class="mini-label">Teto</div><div class="fs-5 fw-semibold">'+tetoValorSingle+'</div><div class="mini-label '+(data.teto_excedido?'text-danger fw-semibold':'text-muted')+'">'+tetoCardSubtitle+'</div></div></div>';
      html+='<div class="col-12"><div class="card p-3 bg-light"><div class="mini-label">Total final</div><div class="fs-4 fw-bold">'+totalFinalSingle+'</div>';
      if(totalOriginalSingle !== totalFinalSingle){
        html += '<div class="small text-muted">Original '+totalOriginalSingle+'</div>';
      }
      html+='</div></div>';
      html+='</div><div class="soft mt-2">UCO usado: <strong>'+ (data.uco_valor||'-') +'</strong> · Porte: <strong>'+ (data.porte_tabela_usada||'-') +'</strong> · Porte AN: <strong>'+ (data.porte_an_tabela_usada||'-') +'</strong> · Ajustes: Porte <strong>'+ (data.ajuste_porte_pct||'0') +'%</strong>, Porte AN <strong>'+ (data.ajuste_porte_an_pct||'0') +'%</strong> · Redutor via entrada: <strong>'+ pctLabel +'</strong> · Teto: '+ statusBadgeSingle +'</div>';
      {% if show_tuss_rol %}
      html+='<div class="soft mt-1">ROL ANS: '+ rolBadgeSingle +'</div>';
      {% endif %}
      if(excedenteSingle !== '-' && hasTetoInfo){
        html+='<div class="soft text-danger">Excedente calculado: <strong>'+excedenteSingle+'</strong>'+ (excedPctSingle?` (<strong>${excedPctSingle}</strong>)`:'') +'</div>';
      }
      const baseline = window._cbhpmBaselineScenario;
      if(baseline && baseline.metrics){
        const currentMetrics = scenarioMetricsFromResult(data);
        if(currentMetrics){
          const baseMetrics = baseline.metrics || {};
          const diffTotal = Number.isFinite(currentMetrics.total) && Number.isFinite(baseMetrics.total) ? currentMetrics.total - baseMetrics.total : NaN;
          const diffExced = Number.isFinite(currentMetrics.excedente) && Number.isFinite(baseMetrics.excedente) ? currentMetrics.excedente - baseMetrics.excedente : NaN;
          const diffPct = Number.isFinite(currentMetrics.excedPct) && Number.isFinite(baseMetrics.excedPct) ? (currentMetrics.excedPct - baseMetrics.excedPct) : NaN;
          const pctLabelDiff = formatDiffPercent(diffPct);
          html += `<div class="soft mt-2">Comparação com “${esc(baseline.name || 'Sem nome')}”: Total ${formatDiffCurrency(diffTotal)} · Excedente ${formatDiffCurrency(diffExced)}${pctLabelDiff?` · Δ% excedente ${pctLabelDiff}`:''}</div>`;
        }
      }
      if(baseCode){
        const currentPct = serverMap[baseCode] || _getViaPctFor(baseCode);
        html+='<div class="mt-3"><label class="form-label">Redutor por via de entrada</label>'+
          `<select class="form-select form-select-sm via-selector" data-code="${baseCode}">`+
          VIA_PCT_OPTIONS.map(opt=>`<option value="${opt}" ${opt===String(currentPct)?'selected':''}>${opt}%</option>`).join('')+
          '</select></div>';
        _setViaPctFor(baseCode, currentPct);
        _pruneViaPctStore([baseCode]);
      }
      out.innerHTML=html;
      if(window.lucide)lucide.createIcons();
      initTooltips(out);
      out.querySelectorAll('.via-selector').forEach(sel=>{
        sel.addEventListener('change', (ev)=>{
          const code = ev.target.dataset.code;
          const val = ev.target.value;
          _setViaPctFor(code, val);
          simularCBHPM();
        });
      });
    })
    .catch(()=>{ window._cbhpmHasResult = false; document.getElementById('cbhpm-out').innerHTML='<div class="alert alert-danger">Erro ao simular.</div>'; });
}

function simularDTP(){
  const tabela=document.getElementById('dtp-tabela').value;
  const q=document.getElementById('dtp-q').value.trim();
  const uf=document.getElementById('dtp-uf').value.trim();
  const out=document.getElementById('dtp-out');
  if(!tabela){ out.innerHTML='<div class="alert alert-warning">Selecione a tabela DTP.</div>'; return; }
  out.innerHTML='<div class="soft">Buscando...</div>';

  const url=new URL('/api/simulacao_dtp', window.location.origin);
  url.searchParams.set('tabela_nome',tabela);
  if(q)url.searchParams.set('q',q);
  if(uf)url.searchParams.set('uf',uf);

  fetch(url).then(r=>r.json()).then(data=>{
    const itens=(data&&data.itens)?data.itens:[];
    if(!itens.length){ out.innerHTML='<div class="empty"><i data-lucide="search-x"></i> Sem itens.</div>'; if(window.lucide)lucide.createIcons(); return; }
    let html='<div class="table-responsive"><table class="table table-sm table-striped align-middle mb-0">';
    html+='<thead class="table-light"><tr><th style="width:140px">Código</th><th>Descrição</th><th class="text-end" style="width:140px">Valor</th></tr></thead><tbody>';
    itens.forEach(it=>{ html+='<tr><td>'+ (it.codigo||'-') +'</td><td>'+ (it.descricao||'-') +'</td><td class="text-end">'+ brl(it.valor) +'</td></tr>'; });
    html+='</tbody></table></div>';
    if(typeof data.total!=='undefined'){ html+='<div class="mt-2 soft">Soma (itens listados): <strong>'+brl(data.total)+'</strong></div>'; }
    out.innerHTML=html;
  }).catch(()=>{ out.innerHTML='<div class="alert alert-danger">Erro ao buscar DTP.</div>'; });
}


function addCodigoPacote(codigo, meta){
  if(!codigo) return false;
  const textarea=document.getElementById('cbhpm-pacote');
  if(!textarea) return false;
  const atual=parsePacote(textarea.value);
  if(atual.includes(codigo)) return false;
  atual.push(codigo);
  textarea.value=atual.join('\n');
  textarea.dispatchEvent(new Event('input'));
  if(meta && meta.codigo){
    cbhpmDtpMeta.set(meta.codigo, {
      codigo: meta.codigo,
      descricao: meta.descricao || '',
      valor: meta.valor,
      tabela_nome: meta.tabela_nome || meta.tabela || '',
      uf: meta.uf || ''
    });
  }else{
    cbhpmDtpMeta.delete(codigo);
  }
  return true;
}


async function buscarDTPPacote(){
  const tabela=document.getElementById('cbhpm-dtp-tabela')?.value || '';
  const termo=document.getElementById('cbhpm-dtp-q')?.value.trim() || '';
  const uf=document.getElementById('cbhpm-dtp-uf')?.value.trim() || '';
  const container=document.getElementById('cbhpm-dtp-results');
  if(!container) return;
  if(!tabela){
    container.innerHTML='<div class="alert alert-warning">Selecione a tabela DTP.</div>';
    return;
  }
  container.innerHTML='<div class="soft">Buscando...</div>';
  const url=new URL('/api/simulacao_dtp', window.location.origin);
  url.searchParams.set('tabela_nome', tabela);
  if(termo) url.searchParams.set('q', termo);
  if(uf) url.searchParams.set('uf', uf);
  cbhpmDtpSearchCache.clear();
  const esc=(s)=>String(s ?? '').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  try{
    const resp=await fetch(url);
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const data=await resp.json();
    const itens=Array.isArray(data?.itens)?data.itens:[];
    if(!itens.length){
      container.innerHTML='<div class="empty"><i data-lucide="search-x"></i> Sem itens.</div>';
      if(window.lucide) lucide.createIcons();
      return;
    }
    let html='<div class="table-responsive"><table class="table table-sm table-hover align-middle mb-0">';
    html+='<thead class="table-light"><tr><th style="width:120px">Codigo</th><th>Descricao</th><th class="text-end" style="width:120px">Valor</th><th class="text-end" style="width:110px"></th></tr></thead><tbody>';
    itens.forEach((it, idx)=>{
      const rawCode=String(it.codigo ?? '').trim();
      const key=rawCode+'|'+tabela+'|'+uf+'|'+idx;
      cbhpmDtpSearchCache.set(key, {
        codigo: rawCode,
        descricao: it.descricao ?? '',
        valor: it.valor,
        tabela_nome: tabela,
        uf
      });
      html+='<tr><td>'+esc(rawCode)+'</td><td>'+esc(it.descricao ?? '')+'</td><td class="text-end">'+brl(it.valor)+'</td><td class="text-end"><button type="button" class="btn btn-sm btn-outline-success js-add-dtp" data-key="'+esc(key)+'"><i data-lucide="plus"></i> Adicionar</button></td></tr>';
    });
    html+='</tbody></table></div>';
    container.innerHTML=html;
    if(window.lucide) lucide.createIcons();
  }catch(err){
    console.error('cbhpm-dtp-helper', err);
    container.innerHTML='<div class="alert alert-danger">Falha ao buscar DTP.</div>';
  }
}



/* ===== Procedimentos: autocomplete com múltipla seleção ===== */
(function(){
  const picker = document.getElementById('procPicker');
  if(!picker) return;

  const input = document.getElementById('procInput');
  const list  = document.getElementById('procList');
  const chips = document.getElementById('procChips');
  const form  = picker.closest('form');

  let results = [];
  let activeIndex = -1;
  let selected = new Map(); // key=codigo, value={codigo, descricao}

  // Restaura selecionados vindos do servidor (se quiser, injete via Jinja em window._iniciais)
  if(Array.isArray(window._procedimentosSelecionados)){
    window._procedimentosSelecionados.forEach(raw=>{
      if(!raw) return;
      if(typeof raw === 'string'){
        const code = raw.split(' - ', 1)[0].trim();
        if(!code) return;
        addSelection({ codigo: code, descricao: raw });
      }else if(raw && raw.codigo){
        addSelection(raw);
      }
    });
  }

  function paramsComContexto(){
    // Opcional: envia tabela/UF atuais para refinar a busca no backend
    const tabelaSel   = form?.querySelector('[name="tabela_nome"]')?.value || '';
    const ufSel       = form?.querySelector('[name="uf"]')?.value || '';
    return { tabela_nome: tabelaSel, uf: ufSel };
  }

  function renderList(){
    list.innerHTML = results.map((r,idx)=>`
      <div class="ap-item ${idx===activeIndex?'active':''}" data-codigo="${escapeAttr(r.codigo)}" title="${escapeHtml(r.descricao||'')}">
        <div class="ap-code">${escapeHtml(r.codigo ?? '-')}</div>
        <div class="ap-desc">${escapeHtml(r.descricao ?? '')}</div>
      </div>
    `).join('');
    list.hidden = results.length === 0;
  }


  function renderChips(){
    chips.innerHTML = [...selected.values()].map(v=>`
      <span class="ap-chip" data-codigo="${escapeAttr(v.codigo)}">
        <span class="ap-code">${escapeHtml(v.codigo)}</span>
        <span class="ap-muted" title="${escapeHtml(v.descricao||'')}">${truncate(v.descricao||'', 40)}</span>
        <span class="ap-x" aria-label="Remover">&times;</span>
        <input type="hidden" name="procedimentos" value="${escapeAttr(v.codigo)}">
      </span>
    `).join('');
  }

  function addSelection(item){
    if(!item || !item.codigo) return;
    if(selected.has(item.codigo)) return;
    selected.set(item.codigo, item);
    renderChips();
  }

  function removeSelection(codigo){
    selected.delete(codigo);
    renderChips();
  }

  function pick(index){
    const it = results[index];
    if(it){ addSelection(it); }
    input.value = '';
    results = [];
    renderList();
    activeIndex = -1;
  }

  // Busca com debounce
  const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
  const buscar = ((fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; })(async (q)=>{
  q = (q||'').trim();
  if(q.length < 2){ results=[]; renderList(); return; }

  const ctx = paramsComContexto();
  const qs = new URLSearchParams({ q, limit: '50' });
  if(ctx.tabela_nome) qs.set('tabela_nome', ctx.tabela_nome);
  if(ctx.uf)          qs.set('uf', ctx.uf);

  try{
    const resp = await fetch(`${PROCEDIMENTO_SUGGEST_URL}?${qs.toString()}`);
    if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    results = Array.isArray(data.items) ? data.items.map(x=>({
      codigo: x.codigo ?? x.id ?? '',
      descricao: x.descricao ?? x.nome ?? '',
      extra: x.caminho ?? x.grupo ?? ''
    })).filter(x=>x.codigo && !selected.has(x.codigo)) : [];
    activeIndex = results.length ? 0 : -1;
    renderList();
  }catch(err){
    console.error('suggest fail:', err);
    results=[]; renderList();
  }
}, 200);

  // Eventos
  input.addEventListener('input', e=> buscar(e.target.value));
  input.addEventListener('keydown', e=>{
    if(list.hidden) return;
    if(e.key === 'ArrowDown'){ e.preventDefault(); activeIndex = Math.min(activeIndex+1, results.length-1); renderList(); }
    else if(e.key === 'ArrowUp'){ e.preventDefault(); activeIndex = Math.max(activeIndex-1, 0); renderList(); }
    else if(e.key === 'Enter'){ e.preventDefault(); pick(activeIndex); }
    else if(e.key === 'Escape'){ results=[]; renderList(); }
  });

  list.addEventListener('mousedown', e=>{
    const it = e.target.closest('.ap-item');
    if(!it) return;
    const idx = [...list.children].indexOf(it);
    pick(idx);
  });

  chips.addEventListener('click', e=>{
    const x = e.target.closest('.ap-x');
    if(!x) return;
    const chip = x.closest('.ap-chip');
    removeSelection(chip?.dataset?.codigo);
  });

  // Fecha lista ao clicar fora
  document.addEventListener('click', e=>{
    if(!picker.contains(e.target)){ results=[]; renderList(); }
  });

  // Helpers
  function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function truncate(s, n){ s=s||''; return s.length>n ? s.slice(0,n-1)+'...' : s; }
  function escapeAttr(s){
  return (s??'').toString().replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#39;'}[m]));
}
})();
/* ===== Picker CBHPM (multi-select) ===== */
(function(){
  const wrap  = document.getElementById('cbhpmProcPicker');
  if(!wrap) return;

  const input = document.getElementById('cbhpmInput');
  const list  = document.getElementById('cbhpmList');
  const chips = document.getElementById('cbhpmChips');
  const countLabel = document.getElementById('cbhpmProcCounter');
  const hintWrap = document.getElementById('cbhpmVersoesHint');
  const hintList = document.getElementById('cbhpmVersoesHintList');
  if(!input || !list || !chips) return;

  wrap.setAttribute('aria-controls', 'cbhpmList');
  input.setAttribute('aria-controls', 'cbhpmList');
  input.setAttribute('aria-autocomplete', 'list');

  let results = [];
  let activeIndex = -1;
  const selected = new Map();
  let lastQuery = '';
  const MIN_CHARS = 2;
  const versoesCache = new Map(); // chave composta codigo+UF
  const versoesByCodigo = new Map();

  function escapeHtml(value){
    return String(value ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  }
  function escapeAttr(value){
    return escapeHtml(value);
  }
  function truncate(value, max){
    const text = String(value ?? '');
    return text.length > max ? text.slice(0, max - 3) + '...' : text;
  }

  function formUfFiltro(){
    const sel = document.querySelector('select[name="uf"]');
    return sel ? (sel.value || '') : '';
  }

  function versaoSelecionada(){
    const sel = document.getElementById('cbhpm-versao');
    return sel && sel.value ? sel.value : '';
  }
  function ufSelecionada(){
    const sel = document.getElementById('cbhpm-uf');
    return sel ? (sel.value || '') : '';
  }

  function cacheKey(code, uf){
    return `${code}@@${uf || ''}`;
  }

  function setExpanded(state){
    wrap.setAttribute('aria-expanded', state ? 'true' : 'false');
    input.setAttribute('aria-expanded', state ? 'true' : 'false');
  }

  function closeList(){
    list.hidden = true;
    list.innerHTML = '';
    setExpanded(false);
  }

  function showListMessage(message){
    list.innerHTML = `<div class="ap-state">${escapeHtml(message)}</div>`;
    list.hidden = false;
    setExpanded(true);
  }

  function renderList(){
    if(!results.length){
      if(lastQuery.length >= MIN_CHARS){
        showListMessage('Nenhum procedimento encontrado.');
      }else if(lastQuery.length){
        showListMessage('Digite pelo menos 2 caracteres para buscar.');
      }else{
        closeList();
      }
      input.removeAttribute('aria-activedescendant');
      return;
    }

    const optionsHtml = results.map((item, idx)=>`
      <div class="ap-item ${idx===activeIndex?'active':''}" id="cbhpm-opt-${idx}" role="option" aria-selected="${idx===activeIndex?'true':'false'}" data-codigo="${escapeAttr(item.codigo)}" tabindex="-1">
        <div class="ap-code">${escapeHtml(item.codigo)}</div>
        <div class="ap-desc">
          <div>${escapeHtml(item.descricao || '')}</div>
          ${item.extra ? `<div class="ap-muted">${escapeHtml(item.extra)}</div>` : ''}
        </div>
      </div>
    `).join('');

    list.innerHTML = optionsHtml;
    list.hidden = false;
    setExpanded(true);
    const activeEl = list.querySelector('.ap-item.active');
    if(activeEl){
      input.setAttribute('aria-activedescendant', activeEl.id);
      activeEl.scrollIntoView({ block:'nearest' });
    }else{
      input.removeAttribute('aria-activedescendant');
    }
  }

  function renderChips(){
    chips.innerHTML = [...selected.values()].map(value=>`
      <span class="ap-chip" data-codigo="${escapeAttr(value.codigo)}">
        <span class="ap-code">${escapeHtml(value.codigo)}</span>
        <span class="ap-muted" title="${escapeHtml(value.descricao || '')}">${truncate(value.descricao || '', 40)}</span>
        <span class="ap-x" aria-label="Remover">&times;</span>
        <input type="hidden" name="procedimentos" value="${escapeAttr(value.codigo)}">
      </span>
    `).join('');
    if(countLabel){
      const count = selected.size;
      countLabel.textContent = count ? `${count} selecionado${count>1?'s':''}` : 'Nenhum selecionado';
    }
  }

  function renderVersoesHint(){
    const union = new Set();
    versoesByCodigo.forEach(list=>{
      (Array.isArray(list) ? list : []).forEach(v=>{ if(v) union.add(String(v)); });
    });

    if(!hintWrap || !hintList){
      highlightVersoes([...union]);
      return;
    }

    if(!union.size){
      highlightVersoes([]);
      if(versoesByCodigo.size){
        hintWrap.hidden = false;
        hintList.innerHTML = '<span class="soft">Nenhuma versão CBHPM encontrada para os códigos selecionados.</span>';
      }else{
        hintWrap.hidden = true;
        hintList.innerHTML = '';
      }
      return;
    }

    const sorted = [...union].sort((a,b)=>a.localeCompare(b,'pt-BR'));
    hintList.innerHTML = sorted.map(v=>`<span class="badge">${escapeHtml(v)}</span>`).join('');
    hintWrap.hidden = false;
    highlightVersoes(sorted);
  }

  function ensureVersoes(code){
    const normalized = (code || '').trim();
    if(!normalized) return;
    const ufFiltro = formUfFiltro();
    const key = cacheKey(normalized, ufFiltro);

    if(versoesCache.has(key)){
      versoesByCodigo.set(normalized, versoesCache.get(key));
      renderVersoesHint();
      return;
    }

    if(hintWrap && hintList){
      hintWrap.hidden = false;
      hintList.innerHTML = '<span class="soft">Carregando versões sugeridas...</span>';
    }

    const params = new URLSearchParams({ codigo: normalized });
    if(ufFiltro) params.set('uf', ufFiltro);

    fetch(`${VERSOES_POR_CODIGO_URL}?${params.toString()}`)
      .then(resp=> resp.ok ? resp.json() : [])
      .then(data=>{
        const list = Array.isArray(data) ? data : [];
        versoesCache.set(key, list);
        if(selected.has(normalized)){
          versoesByCodigo.set(normalized, list);
        }
        renderVersoesHint();
      })
      .catch(()=>{
        versoesCache.set(key, []);
        if(selected.has(normalized)){
          versoesByCodigo.set(normalized, []);
        }
        renderVersoesHint();
      });
  }

  function add(item){
    if(!item) return;
    const normalized = (item.codigo || '').trim();
    if(!normalized || selected.has(normalized)) return;
    selected.set(normalized, { ...item, codigo: normalized });
    renderChips();
    ensureVersoes(normalized);
  }

  function remove(codigo){
    if(!codigo) return;
    const normalized = (codigo || '').trim();
    selected.delete(normalized);
    versoesByCodigo.delete(normalized);
    renderChips();
    renderVersoesHint();
  }

  function clearResults(){
    results = [];
    activeIndex = -1;
    closeList();
  }

  function pick(index){
    const item = results[index];
    if(item) add(item);
    input.value = '';
    clearResults();
  }

  const debounce = (fn, ms)=>{ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; };
  const buscar = debounce(async (query)=>{
    query = (query || '').trim();
    lastQuery = query;
    if(query.length < MIN_CHARS){
      results = [];
      renderList();
      return;
    }

    const url = new URL(PROCEDIMENTO_SUGGEST_URL, window.location.origin);
    url.searchParams.set('q', query);
    const versao = versaoSelecionada();
    if(versao) url.searchParams.set('tabela_nome', versao);
    const uf = ufSelecionada();
    if(uf) url.searchParams.set('uf', uf);
    url.searchParams.set('limit', '30');

    try{
      showListMessage('Buscando procedimentos...');
      const response = await fetch(url);
      if(!response.ok){
        results = [];
        renderList();
        return;
      }
      const data = await response.json();
      const items = Array.isArray(data?.items) ? data.items : [];
      results = items.map(x => {
        const codigo = (x.codigo ?? x.id ?? '').toString().trim();
        return {
          codigo,
          descricao: x.descricao ?? x.nome ?? '',
          extra: x.caminho ?? x.grupo ?? ''
        };
      }).filter(x => x.codigo && !selected.has(x.codigo));
      activeIndex = results.length ? 0 : -1;
      renderList();
    }catch(err){
      console.error('suggest fail:', err);
      results = [];
      showListMessage('Não foi possível buscar agora. Tente novamente.');
    }
  }, 180);

  function moveSelection(delta){
    if(!results.length){ return; }
    activeIndex = Math.min(Math.max(activeIndex + delta, 0), results.length - 1);
    renderList();
  }

  input.addEventListener('input', event => buscar(event.target.value));
  input.addEventListener('keydown', event =>{
    if(event.key === 'Enter' && list.hidden){
      const raw = input.value.trim();
      if(raw){
        const code = raw.split(' - ', 1)[0].trim();
        if(code) add({ codigo: code, descricao: raw });
        input.value = '';
      }
      return;
    }
    if(list.hidden && (event.key === 'ArrowDown' || event.key === 'ArrowUp')){
      if(results.length){
        event.preventDefault();
        renderList();
      }
      return;
    }
    if(list.hidden) return;
    if(event.key === 'ArrowDown'){
      event.preventDefault();
      moveSelection(1);
    }else if(event.key === 'ArrowUp'){
      event.preventDefault();
      moveSelection(-1);
    }else if(event.key === 'Enter'){
      event.preventDefault();
      pick(activeIndex);
    }else if(event.key === 'Escape'){
      clearResults();
    }
  });

  list.addEventListener('mousedown', event =>{
    const option = event.target.closest('.ap-item');
    if(!option) return;
    const index = [...list.children].indexOf(option);
    pick(index);
  });

  chips.addEventListener('click', event =>{
    const close = event.target.closest('.ap-x');
    if(!close) return;
    const chip = close.closest('.ap-chip');
    remove(chip?.dataset?.codigo);
  });

  document.addEventListener('click', event =>{
    if(!wrap.contains(event.target)){
      clearResults();
    }
  });

  document.addEventListener('focusin', event =>{
    if(!wrap.contains(event.target)){
      clearResults();
    }
  });

  const initial = Array.isArray(window._procedimentosSelecionados) ? window._procedimentosSelecionados : [];
  initial.forEach(raw => {
    const code = (raw || '').split(' - ', 1)[0].trim();
    if(!code) return;
    add({ codigo: code, descricao: raw });
  });

  window._cbhpm_getSelectedCodes = () => [...selected.keys()];
  window._cbhpm_clearSelection = () => {
    selected.clear();
    versoesByCodigo.clear();
    renderChips();
    renderVersoesHint();
    clearResults();
  };
  window._cbhpm_refreshVersoesHints = () => {
    versoesByCodigo.clear();
    if(!selected.size){
      renderVersoesHint();
      return;
    }
    [...selected.keys()].forEach(code=> ensureVersoes(code));
  };

  renderChips();
  renderVersoesHint();
})();
// === PATCH: garantir que o "comparar" filtre por código digitado + validação visual ===
(function () {
  const form = document.getElementById('consultaForm');
  if (!form) return;
  const submitButton = document.getElementById('btnSubmitComparar');

  const setSubmitLoading = (state) => {
    if (!submitButton) return;
    const spinner = submitButton.querySelector('.spinner-border');
    const labelEl = submitButton.querySelector('[data-state="label"]');
    if (state) {
      submitButton.dataset.loading = 'on';
      submitButton.disabled = true;
      if (spinner) spinner.hidden = false;
      if (labelEl) labelEl.textContent = 'Consultando...';
    } else {
      submitButton.dataset.loading = 'off';
      submitButton.disabled = false;
      if (spinner) spinner.hidden = true;
      if (labelEl) labelEl.textContent = submitButton?.dataset?.defaultLabel || 'Comparar';
    }
  };

  const extractCodes = (raw) => {
    if (!raw) return [];
    const txt = String(raw).trim();
    if (!txt) return [];
    const parts = txt.split(/\r?\n|[;,]+|\s+/).filter(Boolean);
    const codes = [];
    parts.forEach((p) => {
      const code = p.split(' - ', 1)[0].trim();
      if (code) codes.push(code);
    });
    return codes;
  };

  form.addEventListener('submit', (ev) => {
    const already = form.querySelectorAll('input[name="procedimentos"]').length;
    if (!form.checkValidity()) {
      ev.preventDefault();
      ev.stopPropagation();
      form.classList.add('was-validated');
      setSubmitLoading(false);
      return;
    }

    form.classList.add('was-validated');

    if (!already) {
      const inputTyped = document.getElementById('cbhpmInput')?.value || '';
      const pacoteRaw = document.getElementById('cbhpm-pacote')?.value || '';
      const fromInput = extractCodes(inputTyped);
      const fromPacote = extractCodes(pacoteRaw);
      const all = [...new Set([...fromInput, ...fromPacote])];
      all.forEach((code) => {
        const hid = document.createElement('input');
        hid.type = 'hidden';
        hid.name = 'procedimentos';
        hid.value = code;
        hid.dataset.autogen = '1';
        form.appendChild(hid);
      });
      if (all.length > 0) {
        const ex = document.createElement('input');
        ex.type = 'hidden';
        ex.name = 'codigo_exact';
        ex.value = '1';
        ex.dataset.autogen = '1';
        form.appendChild(ex);
      }
    }

    const pickerInput = document.getElementById('cbhpmInput');
    if (pickerInput) {
      pickerInput.value = '';
    }

    setSubmitLoading(true);
  });

  const resetProcedimentos = () => {
    if (typeof window._cbhpm_clearSelection === 'function') {
      window._cbhpm_clearSelection();
    }
    form.querySelectorAll('input[data-autogen="1"]').forEach((el) => el.remove());
    const list = document.getElementById('cbhpmList');
    if (list) {
      list.innerHTML = '';
      list.hidden = true;
    }
    const countLabel = document.getElementById('cbhpmProcCounter');
    if (countLabel) countLabel.textContent = 'Nenhum selecionado';
  };

  form.addEventListener('reset', () => {
    setTimeout(() => {
      form.classList.remove('was-validated');
      setSubmitLoading(false);
      resetProcedimentos();
    }, 0);
  });

  const resetBtn = document.getElementById('btnResetFiltros');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      form.reset();
      form.classList.remove('was-validated');
      setSubmitLoading(false);
      resetProcedimentos();
      ['filtroVersoes', 'filtroPrestadores'].forEach((id) => {
        const input = document.getElementById(id);
        if (input) {
          input.value = '';
          input.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
      if (typeof window._applyVersoesFiltro === 'function') window._applyVersoesFiltro();
      if (typeof window._updateVersoesResumo === 'function') window._updateVersoesResumo();
      if (typeof window._applyPrestadoresFiltro === 'function') window._applyPrestadoresFiltro();
      if (typeof window._updatePrestadoresResumo === 'function') window._updatePrestadoresResumo();
    });
  }
})();
/* === Helper: monta o payload do simulador CBHPM (reuso) === */

function getCBHPMPayload(){
  const codigo = document.getElementById('cbhpm-codigo').value.trim();
  const pacoteRaw = document.getElementById('cbhpm-pacote').value;

  let codigos = [];
  const seen = new Set();
  const addCode = (raw)=>{
    const code = (raw || '').split(' - ', 1)[0].trim();
    if(!code || seen.has(code)) return;
    seen.add(code);
    codigos.push(code);
  };

  if(typeof window._cbhpm_getSelectedCodes === 'function'){
    window._cbhpm_getSelectedCodes().forEach(addCode);
  }
  parsePacote(pacoteRaw).forEach(addCode);

  const allCodes = [...codigos];
  const dtpItems = [];
  codigos = codigos.filter(code=>{
    const meta = cbhpmDtpMeta.get(code);
    if(meta){
      dtpItems.push({
        codigo: meta.codigo,
        descricao: meta.descricao,
        valor: meta.valor,
        tabela_nome: meta.tabela_nome || null,
        uf: meta.uf || null
      });
      return false;
    }
    return true;
  });
  const ativos = new Set(allCodes);
  Array.from(cbhpmDtpMeta.keys()).forEach(code=>{ if(!ativos.has(code)) cbhpmDtpMeta.delete(code); });

  const activeCodes = new Set(codigos);
  if(codigo) activeCodes.add(codigo);
  const viaMap = {};
  activeCodes.forEach(code=>{
    const key = _normalizeCode(code);
    if(!key) return;
    const pct = _getViaPctFor(key);
    _setViaPctFor(key, pct);
    viaMap[key] = pct;
  });
  _pruneViaPctStore([...activeCodes]);

  return {
    codigo,
    codigos,
    dtp_items: dtpItems,
    uf:document.getElementById('cbhpm-uf').value,
    versao:document.getElementById('cbhpm-versao').value||null,
    porte_tab:document.getElementById('cbhpm-porte').value||null,
    porte_an_tab:document.getElementById('cbhpm-porte-an').value||null,
    uco_valor:document.getElementById('cbhpm-uco').value,
    filme_valor:document.getElementById('cbhpm-filme').value,
    incidencias:document.getElementById('cbhpm-incid').value,
    ajuste_porte_pct:document.getElementById('cbhpm-aj-porte').value||0,
    ajuste_porte_an_pct:document.getElementById('cbhpm-aj-an').value||0,
    via_entrada_pcts: viaMap,
  };
}

function setCBHPMPayload(data){
  if(!data) return;
  const setValue = (id, value)=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.value = value ?? '';
  };
  setValue('cbhpm-codigo', data.codigo || '');
  setValue('cbhpm-uf', data.uf || '');
  setValue('cbhpm-versao', data.versao || '');
  setValue('cbhpm-porte', data.porte_tab || '');
  setValue('cbhpm-porte-an', data.porte_an_tab || '');
  setValue('cbhpm-uco', data.uco_valor || '');
  setValue('cbhpm-filme', data.filme_valor || '');
  setValue('cbhpm-incid', data.incidencias || '');
  setValue('cbhpm-aj-porte', data.ajuste_porte_pct || '0');
  setValue('cbhpm-aj-an', data.ajuste_porte_an_pct || '0');
  const codigos = Array.isArray(data.codigos) ? data.codigos : [];
  const pacoteField = document.getElementById('cbhpm-pacote');
  if(pacoteField){
    pacoteField.value = codigos.join('\n');
  }

  window._cbhpmViaPctByCode = {};
  const viaMap = (data.via_entrada_pcts && typeof data.via_entrada_pcts === 'object') ? data.via_entrada_pcts : {};
  Object.entries(viaMap).forEach(([key,val])=> _setViaPctFor(key, val));
  if(!Object.keys(window._cbhpmViaPctByCode).length && data.codigo && data.via_entrada_pct){
    _setViaPctFor(data.codigo, data.via_entrada_pct);
  }
  const activeForRestore = [...codigos];
  if(data.codigo) activeForRestore.push(data.codigo);
  _pruneViaPctStore(activeForRestore);

  cbhpmDtpMeta.clear();
  const dtpItems = Array.isArray(data.dtp_items) ? data.dtp_items : [];
  dtpItems.forEach(item=>{
    if(!item || !item.codigo) return;
    cbhpmDtpMeta.set(item.codigo, {
      codigo: item.codigo,
      descricao: item.descricao || '',
      valor: item.valor,
      tabela_nome: item.tabela_nome || null,
      uf: item.uf || null,
    });
  });
  renderDtpSelected();
}

function refreshScenarioSelect(){
  const select = document.getElementById('cbhpmSavedList');
  if(!select) return;
  const scenarios = Array.isArray(window._cbhpmSavedScenarios) ? window._cbhpmSavedScenarios : [];
  const current = select.value;
  select.innerHTML = '<option value="">Cenários salvos...</option>' + scenarios.map(item=>{
    const label = item.name || 'Sem nome';
    return `<option value="${esc(item.id)}">${esc(label)}</option>`;
  }).join('');
  if(current && scenarios.some(s=>s.id === current)){
    select.value = current;
  }
}

function handleSaveScenario(){
  const payload = getCBHPMPayload();
  if(!payload.codigo && (!payload.codigos || !payload.codigos.length) && (!payload.dtp_items || !payload.dtp_items.length)){
    alert('Informe ao menos um código ou pacote antes de salvar.');
    return;
  }
  if(!window._cbhpmCurrentResult){
    alert('Execute a simulação antes de salvar o cenário.');
    return;
  }
  const defaultName = payload.codigo || (payload.codigos && payload.codigos[0]) || `Cenário ${new Date().toLocaleString('pt-BR')}`;
  const name = prompt('Nome para o cenário:', defaultName);
  if(!name) return;
  const scenarios = Array.isArray(window._cbhpmSavedScenarios) ? window._cbhpmSavedScenarios : [];
  const metrics = scenarioMetricsFromResult(window._cbhpmCurrentResult) || {};
  const scenario = {
    id: (Date.now().toString(36) + Math.random().toString(36).slice(2, 7)),
    name: name.trim(),
    created_at: new Date().toISOString(),
    payload,
    metrics
  };
  scenarios.push(scenario);
  window._cbhpmSavedScenarios = scenarios;
  persistSavedScenarios(scenarios);
  refreshScenarioSelect();
  if(window.showToast){
    showToast('Cenário salvo com sucesso.', 'success');
  }
}

function handleApplyScenario(){
  const select = document.getElementById('cbhpmSavedList');
  if(!select || !select.value) return;
  const scenarios = Array.isArray(window._cbhpmSavedScenarios) ? window._cbhpmSavedScenarios : [];
  const scenario = scenarios.find(s=>s.id === select.value);
  if(!scenario){
    alert('Cenário não encontrado.');
    return;
  }
  setCBHPMPayload(scenario.payload);
  window._cbhpmBaselineScenario = scenario;
  simularCBHPM();
}

function handleDeleteScenario(){
  const select = document.getElementById('cbhpmSavedList');
  if(!select || !select.value) return;
  if(!confirm('Remover o cenário selecionado?')) return;
  let scenarios = Array.isArray(window._cbhpmSavedScenarios) ? window._cbhpmSavedScenarios : [];
  scenarios = scenarios.filter(s=>s.id !== select.value);
  window._cbhpmSavedScenarios = scenarios;
  persistSavedScenarios(scenarios);
  refreshScenarioSelect();
  select.value = '';
}

function setupScenarioControls(){
  const saveBtn = document.getElementById('btnSaveScenario');
  if(saveBtn && !saveBtn.dataset._bound){
    saveBtn.addEventListener('click', handleSaveScenario);
    saveBtn.dataset._bound = '1';
  }
  const applyBtn = document.getElementById('btnApplyScenario');
  if(applyBtn && !applyBtn.dataset._bound){
    applyBtn.addEventListener('click', handleApplyScenario);
    applyBtn.dataset._bound = '1';
  }
  const deleteBtn = document.getElementById('btnDeleteScenario');
  if(deleteBtn && !deleteBtn.dataset._bound){
    deleteBtn.addEventListener('click', handleDeleteScenario);
    deleteBtn.dataset._bound = '1';
  }
  refreshScenarioSelect();
}

async function exportCBHPM(fmt){ // fmt: 'pdf' | 'xlsx'

  const endpoint = fmt === 'xlsx' ? '/api/simulacao_cbhpm/xlsx' : '/api/simulacao_cbhpm/pdf';

  const btnX = document.getElementById('btnExportCBHPMXLSX');

  const btnP = document.getElementById('btnExportCBHPMPDF');

  const disable = (b)=>{ b && (b.disabled = true); };

  const enable  = (b)=>{ b && (b.disabled = false); };



  try{

    disable(btnX); disable(btnP);



    const payload = getCBHPMPayload();

    if(!payload.codigo && (!payload.codigos || !payload.codigos.length) && (!payload.dtp_items || !payload.dtp_items.length)){

      alert('Informe ao menos um código ou um pacote (múltiplos códigos).');

      return;

    }



    const resp = await fetch(endpoint, {

      method:'POST',

      headers:{'Content-Type':'application/json'},

      body:JSON.stringify(payload)

    });



    if(!resp.ok){

      const msg = await resp.text().catch(()=> '');

      throw new Error(`Falha na exportação (${resp.status}). ${msg || ''}`);

    }



    const blob = await resp.blob();

    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');

    const filename = `simulacao-cbhpm-${stamp}.${fmt}`;

    saveBlobAsFile(blob, filename);

  }catch(err){

    console.error('export fail:', err);

    alert('Não foi possível exportar. Verifique os campos e tente novamente.');

  }finally{

    enable(btnX); enable(btnP);

  }

}



/* === Helpers de download === */
function saveBlobAsFile(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===== Bindings ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  initRadar();
  const versoesHelper = initChecklistFilter({
    containerId: 'versoesChecklist',
    inputId: 'filtroVersoes',
    countId: 'versoesCount',
    checkboxSelector: '.ver-chk'
  });
  if(versoesHelper){
    window._updateVersoesResumo = versoesHelper.updateCount;
    window._applyVersoesFiltro = versoesHelper.applyFilter;
  }else{
    window._updateVersoesResumo = ()=>{};
    window._applyVersoesFiltro = ()=>{};
  }

  const prestadoresHelper = initChecklistFilter({
    containerId: 'prestadoresChecklist',
    inputId: 'filtroPrestadores',
    countId: 'prestadoresCount',
    checkboxSelector: 'input[type="checkbox"]'
  });
  if(prestadoresHelper){
    window._updatePrestadoresResumo = prestadoresHelper.updateCount;
    window._applyPrestadoresFiltro = prestadoresHelper.applyFilter;
  }else{
    window._updatePrestadoresResumo = ()=>{};
    window._applyPrestadoresFiltro = ()=>{};
  }

  document.querySelector('select[name="uf"]')?.addEventListener('change', ()=>{
    if(typeof window._cbhpm_refreshVersoesHints === 'function'){
      window._cbhpm_refreshVersoesHints();
    }
  });

  document.getElementById('btnMarkAllVersoes')?.addEventListener('click',()=>toggleAllVersoes(true));
  document.getElementById('btnClearVersoes')?.addEventListener('click',()=>toggleAllVersoes(false));

  document.getElementById('btnOpenComboModal')?.addEventListener('click', ()=>{
    if(window.comboBuilder?.open){
      window.comboBuilder.open();
    }
  });

  document.addEventListener('click', (ev)=>{
    const addBtn = ev.target.closest('.js-add-combo');
    if(addBtn){
      ev.preventDefault();
      const codigo = (addBtn.getAttribute('data-codigo') || '').trim();
      const descricao = addBtn.getAttribute('data-descricao') || '';
      if(window.comboBuilder?.addItem){
        window.comboBuilder.addItem({ codigo, descricao, quantidade: 1 });
      }else{
        alert('Construtor de combos indisponível nesta visualização.');
      }
      return;
    }
    const btn=ev.target.closest('.js-open-detalhe');
    if(btn){ ev.preventDefault(); openDetalhe(btn.getAttribute('data-codigo')); }
  });

  document.getElementById('btnCopyResults')?.addEventListener('click', copyResults);
  document.getElementById('btnExportCSV')?.addEventListener('click', exportCSV);

  document.getElementById('btnCbhpmDtpBuscar')?.addEventListener('click', buscarDTPPacote);
  document.getElementById('cbhpm-dtp-q')?.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); buscarDTPPacote(); } });
  document.getElementById('cbhpm-pacote')?.addEventListener('input', ()=>{
    const textarea=document.getElementById('cbhpm-pacote');
    const ativos=new Set(parsePacote(textarea ? textarea.value : ''));
    Array.from(cbhpmDtpMeta.keys()).forEach(code=>{ if(!ativos.has(code)) cbhpmDtpMeta.delete(code); });
    renderDtpSelected();
  });
  const dtpHelper=document.getElementById('cbhpm-dtp-results');
  if(dtpHelper){
    dtpHelper.addEventListener('click', ev=>{
      const btn=ev.target.closest('.js-add-dtp');
      if(!btn) return;
      ev.preventDefault();
      const key=btn.getAttribute('data-key')||'';
      const meta=cbhpmDtpSearchCache.get(key);
      const codigo=meta?.codigo || '';
      if(!codigo) return;
      if(addCodigoPacote(codigo, meta)){
        if(window.showToast){ showToast('Codigo '+codigo+' adicionado ao pacote.','success'); }
      }else if(window.showToast){
        showToast('Codigo '+codigo+' ja esta no pacote.','info');
      }
    });
  }
  document.getElementById('cbhpm-dtp-selected')?.addEventListener('click', ev=>{
    const btn=ev.target.closest('.js-remove-dtp');
    if(!btn) return;
    ev.preventDefault();
    const codigo=btn.getAttribute('data-code');
    if(!codigo) return;
    cbhpmDtpMeta.delete(codigo);
    const textarea=document.getElementById('cbhpm-pacote');
    if(textarea){
      const atual=parsePacote(textarea.value).filter(c=>c!==codigo);
      textarea.value=atual.join('\n');
      textarea.dispatchEvent(new Event('input'));
    }
    renderDtpSelected();
  });
  document.getElementById('btnSimularCBHPM')?.addEventListener('click', simularCBHPM);
  document.getElementById('btnBuscarDTP')?.addEventListener('click', simularDTP);
  document.getElementById('btnExportCBHPMXLSX')?.addEventListener('click', ()=>exportCBHPM('xlsx'));
  document.getElementById('btnExportCBHPMPDF')?.addEventListener('click',  ()=>exportCBHPM('pdf'));
  renderDtpSelected();
  setupScenarioControls();
  if (restoreCbhpmPayload) {
    setCBHPMPayload(restoreCbhpmPayload);
    setTimeout(()=>{ simularCBHPM(); }, 150);
  }
});
</script>
{% endblock %}
